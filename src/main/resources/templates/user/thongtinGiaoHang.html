<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán - Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Header -->
<div class="bg-primary text-white py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-0">
                    <i class="fas fa-shopping-bag me-3"></i>
                    Thanh Toán
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="/cart" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>
                    Quay lại giỏ hàng
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Step Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between position-relative">
                <div class="text-center">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 40px; height: 40px;">
                        <i class="fas fa-check"></i>
                    </div>
                    <small>Giỏ hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 40px; height: 40px;">
                        2
                    </div>
                    <small>Thông tin giao hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 40px; height: 40px;">
                        3
                    </div>
                    <small>Thanh toán</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 40px; height: 40px;">
                        4
                    </div>
                    <small>Hoàn thành</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertContainer"></div>

    <form id="checkoutForm" class="needs-validation" novalidate>
        <div class="row">
            <!-- Left - Delivery Info -->
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h4 class="mb-0 text-primary">
                            <i class="fas fa-shipping-fast me-2"></i>
                            Thông tin giao hàng
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Customer Info -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2 text-secondary"></i>
                                Thông tin người nhận
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hoTen" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="hoTen" name="hoTen" required>
                                    <div class="invalid-feedback">Vui lòng nhập họ và tên</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="soDienThoai" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="soDienThoai" name="soDienThoai" required>
                                    <div class="invalid-feedback">Vui lòng nhập số điện thoại</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt me-2 text-secondary"></i>
                                Địa chỉ giao hàng
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tinhThanh" class="form-label">Tỉnh/Thành <span class="text-danger">*</span></label>
                                    <select class="form-select" id="tinhThanh" name="tinhThanh" required>
                                        <option value="">Chọn tỉnh/thành</option>
                                        <option value="hanoi">Hà Nội</option>
                                        <option value="hcm">TP. Hồ Chí Minh</option>
                                        <option value="danang">Đà Nẵng</option>
                                        <option value="haiphong">Hải Phòng</option>
                                        <option value="cantho">Cần Thơ</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn tỉnh/thành</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="quanHuyen" class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                                    <select class="form-select" id="quanHuyen" name="quanHuyen" required>
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn quận/huyện</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="phuongXa" class="form-label">Phường/Xã <span class="text-danger">*</span></label>
                                    <select class="form-select" id="phuongXa" name="phuongXa" required>
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn phường/xã</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="diaChiChiTiet" class="form-label">Địa chỉ chi tiết <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="diaChiChiTiet" name="diaChiChiTiet" rows="2" placeholder="Số nhà, tên đường..." required></textarea>
                                <div class="invalid-feedback">Vui lòng nhập địa chỉ chi tiết</div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-credit-card me-2 text-secondary"></i>
                                Phương thức thanh toán
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="cod">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan" value="COD" id="cod">
                                            <label class="form-check-label w-100" for="cod">
                                                <div class="fw-bold">
                                                    <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                                    Thanh toán khi nhận hàng
                                                </div>
                                                <small class="text-muted">Thanh toán bằng tiền mặt khi nhận hàng</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="momo">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan" value="MOMO" id="momo">
                                            <label class="form-check-label w-100" for="momo">
                                                <div class="fw-bold">
                                                    <i class="fas fa-wallet me-2 text-primary"></i>
                                                    Ví MoMo
                                                </div>
                                                <small class="text-muted">Thanh toán qua ví điện tử MoMo</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Note -->
                        <div class="mb-3">
                            <label for="ghiChu" class="form-label">
                                <i class="fas fa-sticky-note me-2 text-secondary"></i>
                                Ghi chú đơn hàng
                            </label>
                            <textarea class="form-control" id="ghiChu" name="ghiChu" rows="3" placeholder="Ghi chú về đơn hàng..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right - Order Summary -->
            <div class="col-lg-5">
                <div class="position-sticky" style="top: 20px;">
                    <!-- Products -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-list me-2"></i>
                                Sản phẩm đã chọn
                            </h5>
                        </div>
                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                            <div id="productsList"></div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-receipt me-2"></i>
                                Tóm tắt đơn hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tạm tính:</span>
                                <span id="subtotal" class="fw-bold">0₫</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Phí vận chuyển:</span>
                                <span class="text-success fw-bold">Miễn phí</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Giảm giá:</span>
                                <span id="discount" class="text-success fw-bold">-0₫</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-4">
                                <strong class="fs-5">Tổng cộng:</strong>
                                <strong id="totalAmount" class="fs-5 text-danger">0₫</strong>
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="voucherCode" placeholder="Mã giảm giá">
                                <button class="btn btn-outline-secondary" type="button" id="applyVoucher">Áp dụng</button>
                            </div>
                            <button type="submit" class="btn btn-success w-100 btn-lg mb-3">
                                <i class="fas fa-lock me-2"></i>
                                Đặt hàng
                            </button>
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Thông tin được bảo mật
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    class CheckoutPage {
        constructor() {
            this.cartData = null;
            this.init();
        }

        init() {
            this.loadCartData();
            this.bindEvents();
        }

        bindEvents() {
            // Payment method
            document.querySelectorAll('.payment-method').forEach(el => {
                el.addEventListener('click', () => {
                    const radio = el.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                    this.updatePaymentUI();
                });
            });

            // Address
            document.getElementById('tinhThanh').addEventListener('change', () => this.loadDistricts());
            document.getElementById('quanHuyen').addEventListener('change', () => this.loadWards());

            // Form
            document.getElementById('checkoutForm').addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.validateForm()) this.processOrder();
            });

            // Voucher
            document.getElementById('applyVoucher').addEventListener('click', () => this.applyVoucher());
        }

        async loadCartData() {
            try {
                const response = await fetch('/cart/info');
                const data = await response.json();

                if (data.isEmpty) {
                    window.location.href = '/cart';
                    return;
                }

                this.cartData = data;
                this.renderProducts(data.items);
                this.updateSummary(data);
            } catch (error) {
                this.showAlert('Lỗi tải giỏ hàng', 'danger');
            }
        }

        renderProducts(items) {
            const container = document.getElementById('productsList');
            container.innerHTML = items.map(item => `
            <div class="border rounded p-2 mb-2">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        ${item.hinhAnh ?
                `<img src="${item.hinhAnh}" alt="${item.tenSanPham}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>`
            }
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 small">${item.tenSanPham}</h6>
                        <div class="mb-1">
                            ${item.mauSac ? `<span class="badge bg-secondary">${item.mauSac}</span> ` : ''}
                            ${item.congSuat ? `<span class="badge bg-secondary">${item.congSuat}</span>` : ''}
                        </div>
                        <small class="text-muted">SL: ${item.soLuong}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-danger small">${this.formatPrice(item.tongTien)}</div>
                        <small class="text-muted">${this.formatPrice(item.gia)}/cái</small>
                    </div>
                </div>
            </div>
        `).join('');
        }

        updateSummary(data) {
            document.getElementById('subtotal').textContent = this.formatPrice(data.totalAmount);
            document.getElementById('totalAmount').textContent = this.formatPrice(data.totalAmount);
        }

        updatePaymentUI() {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('bg-light'));
            const selected = document.querySelector('input[name="phuongThucThanhToan"]:checked');
            if (selected) selected.closest('.payment-method').classList.add('bg-light');
        }

        loadDistricts() {
            const province = document.getElementById('tinhThanh').value;
            const districtSelect = document.getElementById('quanHuyen');
            const wardSelect = document.getElementById('phuongXa');

            districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
            wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!province) return;

            const districts = {
                'hanoi': ['Ba Đình', 'Hoàn Kiếm', 'Tây Hồ', 'Long Biên', 'Cầu Giấy', 'Đống Đa'],
                'hcm': ['Quận 1', 'Quận 2', 'Quận 3', 'Quận 4', 'Quận 5', 'Quận 7'],
                'danang': ['Hải Châu', 'Thanh Khê', 'Sơn Trà', 'Ngũ Hành Sơn'],
                'haiphong': ['Hồng Bàng', 'Ngô Quyền', 'Lê Chân', 'Hải An'],
                'cantho': ['Ninh Kiều', 'Bình Thủy', 'Cái Răng', 'Ô Môn']
            };

            if (districts[province]) {
                districts[province].forEach(district => {
                    districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                });
            }
        }

        loadWards() {
            const district = document.getElementById('quanHuyen').value;
            const wardSelect = document.getElementById('phuongXa');

            wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!district) return;

            // Mock wards
            const wards = ['Phường 1', 'Phường 2', 'Phường 3', 'Phường 4', 'Phường 5'];
            wards.forEach(ward => {
                wardSelect.innerHTML += `<option value="${ward}">${ward}</option>`;
            });
        }

        validateForm() {
            const form = document.getElementById('checkoutForm');
            form.classList.add('was-validated');

            const required = ['hoTen', 'soDienThoai', 'tinhThanh', 'quanHuyen', 'phuongXa', 'diaChiChiTiet'];
            const isValid = required.every(field => document.getElementById(field).value.trim());

            const payment = document.querySelector('input[name="phuongThucThanhToan"]:checked');

            if (!isValid || !payment) {
                this.showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
                return false;
            }

            return true;
        }

        async processOrder() {
            const formData = new FormData(document.getElementById('checkoutForm'));

            try {
                const response = await fetch('/checkout/process', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    this.showAlert('Đặt hàng thành công!', 'success');
                    setTimeout(() => {
                        window.location.href = result.redirectUrl || '/order/success';
                    }, 2000);
                } else {
                    this.showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                this.showAlert('Lỗi kết nối', 'danger');
            }
        }

        async applyVoucher() {
            const code = document.getElementById('voucherCode').value.trim();
            if (!code) {
                this.showAlert('Vui lòng nhập mã giảm giá', 'warning');
                return;
            }

            try {
                const response = await fetch('/voucher/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('discount').textContent = `-${this.formatPrice(result.discountAmount)}`;
                    document.getElementById('totalAmount').textContent = this.formatPrice(result.finalAmount);
                    this.showAlert('Áp dụng mã giảm giá thành công!', 'success');
                } else {
                    this.showAlert(result.message || 'Mã giảm giá không hợp lệ', 'danger');
                }
            } catch (error) {
                this.showAlert('Lỗi áp dụng mã giảm giá', 'danger');
            }
        }

        formatPrice(price) {
            if (!price) return '0₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const id = 'alert-' + Date.now();

            container.insertAdjacentHTML('beforeend', `
            <div id="${id}" class="alert alert-${type} alert-dismissible fade show">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

            setTimeout(() => {
                const alert = document.getElementById(id);
                if (alert) alert.remove();
            }, 5000);
        }
    }

    // Initialize
    new CheckoutPage();
</script>
</body>
</html>