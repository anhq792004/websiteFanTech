<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/user/fragments/head :: head}"></head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thanh Toán - Checkout</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<body class="bg-light">

<!-- Header -->
<div class="bg-primary text-white py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-0">
                    <i class="fas fa-shopping-bag me-3"></i>
                    Thanh Toán
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="/cart" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>
                    Quay lại giỏ hàng
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Step Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between position-relative">
                <div class="text-center">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        <i class="fas fa-check"></i>
                    </div>
                    <small>Giỏ hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        2
                    </div>
                    <small>Thông tin giao hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        3
                    </div>
                    <small>Thanh toán</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        4
                    </div>
                    <small>Hoàn thành</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertContainer"></div>

    <form id="checkoutForm" class="needs-validation" novalidate>
        <div class="row">
            <!-- Left - Delivery Info -->
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h4 class="mb-0 text-primary">
                            <i class="fas fa-shipping-fast me-2"></i>
                            Thông tin giao hàng
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Customer Info -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2 text-secondary"></i>
                                Thông tin người nhận
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hoTen" class="form-label">Họ và tên <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="hoTen" name="hoTen" required>
                                    <div class="invalid-feedback">Vui lòng nhập họ và tên</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="soDienThoai" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="soDienThoai" name="soDienThoai" required>
                                    <div class="invalid-feedback">Vui lòng nhập số điện thoại</div>
                                </div>
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt me-2 text-secondary"></i>
                                Địa chỉ giao hàng
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tinhThanh" class="form-label">Tỉnh/Thành phố <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="tinhThanh" name="tinhThanh" required>
                                        <option value="">Chọn tỉnh/thành phố</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn tỉnh/thành phố</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="quanHuyen" class="form-label">Quận/Huyện <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="quanHuyen" name="quanHuyen" required>
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn quận/huyện</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="phuongXa" class="form-label">Phường/Xã <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="phuongXa" name="phuongXa" required>
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn phường/xã</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="diaChiChiTiet" class="form-label">Địa chỉ chi tiết <span
                                        class="text-danger">*</span></label>
                                <textarea class="form-control" id="diaChiChiTiet" name="diaChiChiTiet" rows="2"
                                          placeholder="Số nhà, tên đường..." required></textarea>
                                <div class="invalid-feedback">Vui lòng nhập địa chỉ chi tiết</div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-credit-card me-2 text-secondary"></i>
                                Phương thức thanh toán
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="cod">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                   value="TIEN_MAT" id="TIEN_MAT">
                                            <label class="form-check-label w-100" for="TIEN_MAT">
                                                <div class="fw-bold">
                                                    <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                                    Thanh toán khi nhận hàng
                                                </div>
                                                <small class="text-muted">Thanh toán bằng tiền mặt khi nhận hàng</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="momo">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                   value="MOMO" id="momo">
                                            <label class="form-check-label w-100" for="momo">
                                                <div class="fw-bold">
                                                    <i class="fas fa-wallet me-2 text-primary"></i>
                                                    Ví MoMo
                                                </div>
                                                <small class="text-muted">Thanh toán qua ví điện tử MoMo</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Note -->
                        <div class="mb-3">
                            <label for="ghiChu" class="form-label">
                                <i class="fas fa-sticky-note me-2 text-secondary"></i>
                                Ghi chú đơn hàng
                            </label>
                            <textarea class="form-control" id="ghiChu" name="ghiChu" rows="3"
                                      placeholder="Ghi chú về đơn hàng..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right - Order Summary -->
            <div class="col-lg-5">
                <div class="position-sticky" style="top: 20px;">
                    <!-- Products -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-list me-2"></i>
                                Sản phẩm đã chọn
                            </h5>
                        </div>
                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                            <div id="productsList"></div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-receipt me-2"></i>
                                Tóm tắt đơn hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tạm tính:</span>
                                <span id="subtotal" class="fw-bold">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Tổng khối lượng:</span>
                                <span id="totalWeight">0 kg</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Phí vận chuyển:</span>
                                <span id="shippingFee">0 đ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Giảm giá:</span>
                                <span id="discount" class="text-success fw-bold">0</span>
                            </div>
                            <!-- Thêm thông báo voucher tốt nhất -->
                            <div id="bestVoucherInfo" class="text-success small mb-3" style="display: none;">
                                <i class="fas fa-check-circle me-1"></i>
                                Đã tự động áp dụng phiếu giảm giá tốt nhất
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-4">
                                <strong class="fs-5">Tổng cộng:</strong>
                                <strong id="totalAmount" class="fs-5 text-danger">0</strong>
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="voucherCode" placeholder="Mã giảm giá"
                                       readonly>
                                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal"
                                        data-bs-target="#voucherModal">
                                    <i class="fas fa-ticket-alt"></i> Chọn
                                </button>
                            </div>
                            <button type="submit" class="btn btn-success w-100 btn-lg mb-3">
                                <i class="fas fa-lock me-2"></i>
                                Đặt hàng
                            </button>
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Thông tin được bảo mật
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Voucher Modal -->
<div class="modal fade" id="voucherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-ticket-alt me-2"></i>
                    Chọn phiếu giảm giá
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="vouchersList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="clearVoucherBtn">
                    <i class="fas fa-trash-alt me-1"></i> Bỏ chọn
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    class CheckoutPage {
        constructor() {
            this.cartData = null;
            this.selectedVoucher = null;
            this.addressData = null;
            this.init();
        }

        init() {
            this.loadCartData();
            this.loadAddressData();
            this.bindEvents();
            this.loadAvailableVouchers();
        }

        bindEvents() {
            // Payment method
            document.querySelectorAll('.payment-method').forEach(el => {
                el.addEventListener('click', () => {
                    const radio = el.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                    this.updatePaymentUI();
                });
            });

            // Address
            document.getElementById('tinhThanh').addEventListener('change', () => this.loadDistricts());
            document.getElementById('quanHuyen').addEventListener('change', () => this.loadWards());

            // Form
            document.getElementById('checkoutForm').addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.validateForm()) this.processOrder();
            });

            // Voucher modal
            document.getElementById('voucherModal').addEventListener('shown.bs.modal', () => {
                this.loadAvailableVouchers();
            });

            // Clear voucher button
            document.getElementById('clearVoucherBtn').addEventListener('click', () => {
                this.clearVoucher();
            });
        }

        async loadAddressData() {
            try {
                const response = await axios.get("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json");
                this.addressData = response.data;
                this.renderCities();
            } catch (error) {
                console.error("Lỗi tải dữ liệu địa chỉ:", error);
                this.showAlert('Lỗi tải dữ liệu địa chỉ', 'danger');
            }
        }

        renderCities() {
            const citis = document.getElementById("tinhThanh");
            citis.innerHTML = '<option value="">Chọn tỉnh/thành phố</option>';
            for (const x of this.addressData) {
                citis.options[citis.options.length] = new Option(x.Name, x.Id);
            }
        }

        loadDistricts() {
            const citis = document.getElementById("tinhThanh");
            const districts = document.getElementById("quanHuyen");
            const wards = document.getElementById("phuongXa");

            districts.innerHTML = '<option value="">Chọn quận/huyện</option>';
            wards.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!citis.value) return;

            let selectedCity = this.addressData.find(n => n.Id === citis.value);
            if (selectedCity) {
                for (const k of selectedCity.Districts) {
                    districts.options[districts.options.length] = new Option(k.Name, k.Id);
                }
            }
        }

        loadWards() {
            const citis = document.getElementById("tinhThanh");
            const districts = document.getElementById("quanHuyen");
            const wards = document.getElementById("phuongXa");

            wards.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!citis.value || !districts.value) return;

            let selectedCity = this.addressData.find(n => n.Id === citis.value);
            if (selectedCity) {
                let selectedDistrict = selectedCity.Districts.find(n => n.Id === districts.value);
                if (selectedDistrict) {
                    for (const w of selectedDistrict.Wards) {
                        wards.options[wards.options.length] = new Option(w.Name, w.Id);
                    }
                }
            }
        }

        formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', {style: 'decimal', minimumFractionDigits: 0}) + ' đ';
        }

        findBestVoucher(vouchers, cartTotal) {
            if (!vouchers || vouchers.length === 0) return null;

            let bestVoucher = null;
            let maxDiscount = 0;

            vouchers.forEach(voucher => {
                if (
                    cartTotal >= (voucher.giaTriDonHangToiThieu || 0) &&
                    (voucher.soLuongConLai > 0 || voucher.soLuongConLai === undefined)
                ) {
                    let discount = 0;
                    if (voucher.loaiGiam === 'PERCENT') {
                        discount = cartTotal * (Number(voucher.giaTriGiam) / 100);
                        if (voucher.giaTriGiamToiDa && discount > voucher.giaTriGiamToiDa) {
                            discount = voucher.giaTriGiamToiDa;
                        }
                    } else {
                        discount = Number(voucher.giaTriGiam);
                    }

                    if (discount > maxDiscount) {
                        maxDiscount = discount;
                        bestVoucher = voucher;
                    }
                }
            });

            return bestVoucher;
        }

        async loadCartData() {
            try {
                const response = await fetch('/checkout/cart-info');
                const data = await response.json();

                if (data.isEmpty) {
                    window.location.href = '/cart';
                    return;
                }

                this.cartData = data;
                this.renderProducts(data.items);
                this.updateSummary(data);
            } catch (error) {
                this.showAlert('Lỗi tải giỏ hàng', 'danger');
            }
        }

        renderProducts(items) {
            const container = document.getElementById('productsList');
            container.innerHTML = items.map(item => `
            <div class="border rounded p-2 mb-2">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        ${item.hinhAnh ?
                `<img src="${item.hinhAnh}" alt="${item.tenSanPham}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>`
            }
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 small">${item.tenSanPham}</h6>
                        <div class="mb-1">
                            ${item.mauSac ? `<span class="badge bg-secondary">${item.mauSac}</span> ` : ''}
                            ${item.congSuat ? `<span class="badge bg-secondary">${item.congSuat}</span>` : ''}
                        </div>
                        <small class="text-muted">SL: ${item.soLuong}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-danger small">${this.formatCurrency(item.tongTien)}</div>
                        <small class="text-muted">${this.formatCurrency(item.gia)}/cái</small>
                    </div>
                </div>
            </div>
        `).join('');
        }

        updateSummary(data) {
            document.getElementById('subtotal').textContent = this.formatCurrency(data.totalAmount);
            const weightKg = data.totalWeight ? (data.totalWeight / 1000) : 0;
            document.getElementById('totalWeight').textContent = weightKg.toLocaleString('vi-VN', {maximumFractionDigits: 2}) + ' kg';

            // Tính phí ship
            let shippingFee = 0;
            if (data.totalAmount < 2000000) { // dưới 2 triệu
                shippingFee = Math.ceil(weightKg * 10000); // 10.000đ/kg, làm tròn lên
            }
            document.getElementById('shippingFee').textContent = this.formatCurrency(shippingFee);

            const discountAmount = this.calculateDiscountAmount(data.totalAmount);
            const finalAmount = data.totalAmount - discountAmount + shippingFee;

            document.getElementById('discount').textContent = this.formatCurrency(-discountAmount);
            document.getElementById('totalAmount').textContent = this.formatCurrency(finalAmount);
        }

        updatePaymentUI() {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('bg-light'));
            const selected = document.querySelector('input[name="phuongThucThanhToan"]:checked');
            if (selected) selected.closest('.payment-method').classList.add('bg-light');
        }

        async loadAvailableVouchers() {
            const vouchersList = document.getElementById('vouchersList');
            vouchersList.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2 text-muted">Đang tải danh sách phiếu giảm giá...</p>
        </div>
    `;

            try {
                const response = await fetch('/checkout/PGG');
                if (response.status === 401) {
                    vouchersList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-lock text-warning fa-2x mb-2"></i>
                    <p class="text-muted">Vui lòng đăng nhập để xem phiếu giảm giá</p>
                </div>
            `;
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const vouchers = await response.json();

                if (!this.selectedVoucher && vouchers.length > 0) {
                    const bestVoucher = this.findBestVoucher(vouchers, this.cartData?.totalAmount || 0);
                    if (bestVoucher) {
                        this.selectedVoucher = bestVoucher;
                        document.getElementById('voucherCode').value = bestVoucher.ma;
                        document.getElementById('bestVoucherInfo').style.display = 'block';
                        this.updateSummary(this.cartData);
                    }
                } else if (this.selectedVoucher) {
                    document.getElementById('voucherCode').value = this.selectedVoucher.ma;
                    document.getElementById('bestVoucherInfo').style.display = this.findBestVoucher([this.selectedVoucher], this.cartData?.totalAmount || 0) ? 'block' : 'none';
                    this.updateSummary(this.cartData);
                }

                this.renderVouchers(vouchers);
            } catch (error) {
                console.error('Error loading vouchers:', error);
                this.showAlert('Lỗi tải danh sách phiếu giảm giá', 'danger');
            }
        }

        renderVouchers(vouchers) {
            const container = document.getElementById('vouchersList');

            if (!vouchers || vouchers.length === 0) {
                container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-ticket-alt text-muted fa-2x mb-2"></i>
                <p class="text-muted">Không có phiếu giảm giá khả dụng</p>
                <small class="text-muted">Hãy theo dõi để không bỏ lỡ ưu đãi!</small>
            </div>
        `;
                return;
            }

            const getVoucherTypeInfo = (voucher) => {
                if (voucher.type === 'public' || voucher.loaiPhieu === true) {
                    return { text: 'Công khai', color: 'success', icon: 'globe' };
                } else if (voucher.type === 'private' || voucher.loaiPhieu === false) {
                    return { text: 'Cá nhân', color: 'warning', icon: 'user' };
                }
                return { text: 'Không xác định', color: 'secondary', icon: 'question' };
            };

            const bestVoucher = this.findBestVoucher(vouchers, this.cartData?.totalAmount || 0);

            container.innerHTML = vouchers.map(voucher => {
                const typeInfo = getVoucherTypeInfo(voucher);
                const isBest = bestVoucher && bestVoucher.id === voucher.id;
                return `
            <div class="card mb-3 voucher-item ${this.selectedVoucher?.id === voucher.id ? 'border-primary bg-light' : ''}"
                 style="cursor: pointer;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="bg-gradient bg-primary text-white rounded-3 p-3 shadow-sm">
                                <div class="h5 mb-0 fw-bold">
                                    ${voucher.loaiGiam === 'PERCENT' ? voucher.giaTriGiam : this.formatCurrency(voucher.giaTriGiam)}
                                </div>
                                <small class="opacity-75">
                                    ${voucher.loaiGiam === 'PERCENT' ? 'Giảm %' : 'Giảm tiền'}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 fw-bold me-2">${voucher.ten}</h6>
                                <span class="badge bg-${typeInfo.color}">
                                    <i class="fas fa-${typeInfo.icon} me-1"></i>
                                    ${typeInfo.text}
                                </span>
                                ${isBest ? '<span class="badge bg-success ms-2">Lựa chọn tốt nhất</span>' : ''}
                            </div>
                            <p class="text-muted small mb-2">${voucher.moTa || 'Áp dụng cho đơn hàng'}</p>
                            <div class="small">
                                <div class="mb-1">
                                    <i class="fas fa-shopping-cart text-info me-1"></i>
                                    <span class="text-success">Đơn tối thiểu: ${this.formatCurrency(voucher.giaTriDonHangToiThieu || 0)}</span>
                                </div>
                                ${voucher.giaTriGiamToiDa ? `
                                    <div class="mb-1">
                                        <i class="fas fa-arrow-up text-warning me-1"></i>
                                        <span class="text-warning">Giảm tối đa: ${this.formatCurrency(voucher.giaTriGiamToiDa)}</span>
                                    </div>
                                ` : ''}
                                <div>
                                    <i class="fas fa-clock text-secondary me-1"></i>
                                    <span class="text-muted">Còn ${voucher.soLuongConLai || 0} lượt sử dụng</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn ${this.selectedVoucher?.id === voucher.id ? 'btn-success' : 'btn-outline-primary'} btn-sm select-voucher"
                                    data-voucher='${JSON.stringify(voucher)}'>
                                <i class="fas ${this.selectedVoucher?.id === voucher.id ? 'fa-check' : 'fa-plus'} me-1"></i>
                                ${this.selectedVoucher?.id === voucher.id ? 'Đã chọn' : 'Chọn'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }).join('');

            document.querySelectorAll('.select-voucher').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const voucherData = JSON.parse(e.target.closest('.select-voucher').dataset.voucher);
                    this.selectVoucher(voucherData);
                });
            });
        }

        selectVoucher(voucher) {
            this.selectedVoucher = voucher;

            document.getElementById('voucherCode').value = voucher.ma;
            document.getElementById('bestVoucherInfo').style.display = this.findBestVoucher([voucher], this.cartData?.totalAmount || 0) ? 'block' : 'none';
            this.updateSummary(this.cartData);

            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('border-primary', 'bg-light');
            });

            document.querySelectorAll('.select-voucher').forEach(btn => {
                const btnVoucher = JSON.parse(btn.dataset.voucher);
                if (btnVoucher.id === voucher.id) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã chọn';
                    btn.closest('.voucher-item').classList.add('border-primary', 'bg-light');
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                    btn.innerHTML = '<i class="fas fa-plus me-1"></i>Chọn';
                }
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
            modal.hide();

            this.showAlert(`Đã chọn phiếu giảm giá ${voucher.ten}!`, 'success');
        }

        clearVoucher() {
            this.selectedVoucher = null;

            document.getElementById('voucherCode').value = '';
            document.getElementById('bestVoucherInfo').style.display = 'none';
            this.updateSummary(this.cartData);

            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('border-primary', 'bg-light');
            });

            document.querySelectorAll('.select-voucher').forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
                btn.innerHTML = '<i class="fas fa-plus me-1"></i>Chọn';
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
            modal.hide();

            this.showAlert('Đã bỏ chọn phiếu giảm giá!', 'info');
        }

        calculateDiscountAmount(originalAmount) {
            if (!this.selectedVoucher) return 0;

            const voucher = this.selectedVoucher;
            let discountAmount = 0;

            if (voucher.loaiGiam === 'PERCENT') {
                const percent = Number(voucher.giaTriGiam);
                if (isNaN(percent)) {
                    console.error('giaTriGiam is not a number:', voucher.giaTriGiam);
                    return 0;
                }
                discountAmount = originalAmount * (percent / 100);
            } else {
                discountAmount = Number(voucher.giaTriGiam);
            }

            if (voucher.giaTriGiamToiDa && discountAmount > voucher.giaTriGiamToiDa) {
                discountAmount = voucher.giaTriGiamToiDa;
            }

            return discountAmount;
        }

        validateForm() {
            const form = document.getElementById('checkoutForm');
            form.classList.add('was-validated');

            const required = ['hoTen', 'soDienThoai', 'tinhThanh', 'quanHuyen', 'phuongXa', 'diaChiChiTiet'];
            const isValid = required.every(field => document.getElementById(field).value.trim());

            const payment = document.querySelector('input[name="phuongThucThanhToan"]:checked');

            if (!isValid || !payment) {
                this.showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
                return false;
            }

            return true;
        }

        async processOrder() {
            const formData = new FormData(document.getElementById('checkoutForm'));

            if (this.selectedVoucher) {
                formData.append('voucherId', this.selectedVoucher.id);
            }

            try {
                const response = await fetch('/checkout/process', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Process order response:', result);

                if (result.success) {
                    document.getElementById('discount').textContent = -result.discountAmount;
                    document.getElementById('shippingFee').textContent = result.shippingFee;
                    document.getElementById('totalAmount').textContent = result.finalAmount;

                    if (result.paymentMethod === 'MOMO') {
                        this.handleMomoPayment(result);
                    } else {
                        this.showAlert('Đặt hàng thành công!', 'success');
                        setTimeout(() => {
                            window.location.href = result.redirectUrl || '/checkout/success?id=' + result.orderId;
                        }, 2000);
                    }
                } else {
                    this.showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                this.showAlert('Lỗi kết nối', 'danger');
            }
        }

        handleMomoPayment(result) {
            if (result.payUrl) {
                const confirmed = confirm('Bạn sẽ được chuyển hướng đến trang thanh toán MoMo. Bạn có muốn tiếp tục?');
                if (confirmed) {
                    sessionStorage.setItem('pending_momo_order', result.orderId);
                    sessionStorage.setItem('return_url', window.location.href);
                    window.location.href = result.payUrl;
                } else {
                    this.showAlert('Thanh toán bị hủy', 'warning');
                }
            } else {
                this.showAlert('Không thể tạo liên kết thanh toán MoMo', 'danger');
            }
        }

        checkMomoPaymentStatus() {
            const pendingOrderId = sessionStorage.getItem('pending_momo_order');
            if (pendingOrderId) {
                fetch(`/checkout/check-momo-status?orderId=${pendingOrderId}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            sessionStorage.removeItem('pending_momo_order');
                            sessionStorage.removeItem('return_url');
                            this.showAlert('Thanh toán MoMo thành công!', 'success');
                            setTimeout(() => {
                                window.location.href = '/checkout/success?id=' + pendingOrderId;
                            }, 2000);
                        } else if (result.status === 0) {
                            this.showAlert('Đơn hàng đang chờ thanh toán MoMo', 'info');
                        } else {
                            sessionStorage.removeItem('pending_momo_order');
                            sessionStorage.removeItem('return_url');
                            this.showAlert('Thanh toán MoMo thất bại: ' + result.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking MoMo status:', error);
                    });
            }
        }

        showAlert(message, type) {
            Swal.fire({
                position: 'top-end',
                icon: type,
                title: message,
                showConfirmButton: false,
                timer: 2000,
                toast: true,
                background: type === 'success' ? '#d4edda' : type === 'info' ? '#d1ecf1' : type === 'warning' ? '#fff3cd' : '#f8d7da',
                color: type === 'success' ? '#155724' : type === 'info' ? '#0c5460' : type === 'warning' ? '#856404' : '#721c24',
                iconColor: type === 'success' ? '#28a745' : type === 'info' ? '#17a2b8' : type === 'warning' ? '#ffc107' : '#dc3545'
            });
        }
    }

    const checkoutPage = new CheckoutPage();
    checkoutPage.checkMomoPaymentStatus();
</script>
</body>
</html>