<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}"></head>

<title>Đổi Mật Khẩu</title>
<!-- BASE CSS -->
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/bootstrap.min.css}">
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/style.css}">
<!-- SPECIFIC CSS -->
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/home_1.css}">
<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    .list-group-item {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    .list-group-item span {
        font-size: 1rem;
    }
    .is-invalid {
        border-color: #dc3545;
    }
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>
<body>
<div id="page">
    <header th:replace="/user/fragments/header :: header"></header>
    <main>
        <div class="container">
            <nav aria-label="breadcrumb" class="mt-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Trang chủ</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Đổi mật khẩu</li>
                </ol>
            </nav>
            <div class="row">
                <div class="col-lg-3">
                    <aside th:replace="/user/fragments/sidebar :: sidebar"></aside>
                </div>
                <div class="col-lg-9">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header">
                            <h4>Đổi mật khẩu</h4>
                            <p class="text-muted">Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                        </div>
                        <div class="card-body">
                            <!-- Thông báo từ server -->
                            <div th:if="${message}" class="alert alert-success" role="alert">
                                <span th:text="${message}"></span>
                            </div>
                            <div th:if="${error}" class="alert alert-danger" role="alert">
                                <span th:text="${error}"></span>
                            </div>

                            <!-- Form yêu cầu gửi mã xác thực -->
                            <div th:if="${!showVerificationForm && !showPasswordForm}">
                                <form id="requestCodeForm" th:action="@{/profile/change-password/request}" method="post">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email"
                                               th:value="${session.currentUser?.email}" readonly>
                                    </div>
                                    <button type="submit" class="btn btn-ouline-primary">Gửi mã xác thực</button>
                                </form>
                            </div>

                            <!-- Form nhập mã xác thực -->
                            <div th:if="${showVerificationForm}">
                                <form id="verifyCodeForm" th:action="@{/profile/change-password/verify}" method="post">
                                    <div class="mb-3">
                                        <label for="verificationCode" class="form-label">Mã xác thực</label>
                                        <input type="text" class="form-control" id="verificationCode" name="code"
                                               placeholder="Nhập mã xác thực">
                                        <div class="invalid-feedback" id="verificationCodeError">
                                            Vui lòng nhập mã xác thực (6 chữ số).
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-ouline-primary">Xác nhận</button>
                                </form>
                            </div>

                            <!-- Form nhập mật khẩu mới -->
                            <div th:if="${showPasswordForm}">
                                <form id="changePasswordForm" th:action="@{/profile/change-password/update}" method="post">
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                                        <input type="password" class="form-control" id="newPassword" name="newPassword"
                                               placeholder="Nhập mật khẩu mới">
                                        <div class="invalid-feedback" id="newPasswordError">
                                            Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                               placeholder="Xác nhận mật khẩu mới">
                                        <div class="invalid-feedback" id="confirmPasswordError">
                                            Mật khẩu xác nhận không khớp.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-ouline-primary">Cập nhật mật khẩu</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer th:replace="/user/fragments/footer :: footer"></footer>
</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- COMMON SCRIPTS -->
<script th:src="@{/user/assets/compiled/js/common_scripts.min.js}"></script>
<script th:src="@{/user/assets/compiled/js/main.js}"></script>
<script th:src="@{/user/assets/compiled/js/video_header.min.js}"></script>
<script>
    // Hiển thị thông báo SweetAlert từ server
    const message = /*[[${message}]]*/ null;
    const error = /*[[${error}]]*/ null;

    if (message) {
        Swal.fire({
            icon: 'success',
            title: 'Thành công',
            text: message,
            confirmButtonText: 'OK'
        });
    }
    if (error) {
        Swal.fire({
            icon: 'error',
            title: 'Lỗi',
            text: error,
            confirmButtonText: 'OK'
        });
    }

    // Validate form gửi mã xác thực
    document.getElementById('requestCodeForm')?.addEventListener('submit', function(event) {
        const email = document.getElementById('email').value;
        if (!email) {
            event.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Email không được để trống!',
                confirmButtonText: 'OK'
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Đang gửi',
                text: 'Vui lòng chờ, mã xác thực đang được gửi...',
                showConfirmButton: false,
                timer: 1500
            });
        }
    });

    // Validate form mã xác thực
    document.getElementById('verifyCodeForm')?.addEventListener('submit', function(event) {
        const code = document.getElementById('verificationCode').value;
        const codeRegex = /^\d{6}$/;
        if (!codeRegex.test(code)) {
            event.preventDefault();
            document.getElementById('verificationCode').classList.add('is-invalid');
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Mã xác thực phải là 6 chữ số!',
                confirmButtonText: 'OK'
            });
        } else {
            document.getElementById('verificationCode').classList.remove('is-invalid');
        }
    });

    // Validate form đổi mật khẩu
    document.getElementById('changePasswordForm')?.addEventListener('submit', function(event) {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

        let isValid = true;

        // Kiểm tra mật khẩu mới
        if (!passwordRegex.test(newPassword)) {
            event.preventDefault();
            document.getElementById('newPassword').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('newPassword').classList.remove('is-invalid');
        }

        // Kiểm tra mật khẩu xác nhận
        if (newPassword !== confirmPassword) {
            event.preventDefault();
            document.getElementById('confirmPassword').classList.add('is-invalid');
            isValid = false;
        } else {
            document.getElementById('confirmPassword').classList.remove('is-invalid');
        }

        if (!isValid) {
            event.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Vui lòng kiểm tra lại thông tin nhập vào!',
                confirmButtonText: 'OK'
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Đang cập nhật',
                text: 'Vui lòng chờ, mật khẩu đang được cập nhật...',
                showConfirmButton: false,
                timer: 1500
            });
        }
    });
</script>
<script th:src="@{/user/assets/compiled/js/droptk.js}"></script>
</body>
</html>