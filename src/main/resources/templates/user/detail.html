<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}"></head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="Ansonika">
<title>Chi tiết sản phẩm</title>

<!-- Favicons-->
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" type="image/x-icon" href="img/apple-touch-icon-57x57-precomposed.png">
<link rel="apple-touch-icon" type="image/x-icon" sizes="72x72" href="img/apple-touch-icon-72x72-precomposed.png">
<link rel="apple-touch-icon" type="image/x-icon" sizes="114x114" href="img/apple-touch-icon-114x114-precomposed.png">
<link rel="apple-touch-icon" type="image/x-icon" sizes="144x144" href="img/apple-touch-icon-144x144-precomposed.png">

<!-- GOOGLE WEB FONT -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- BASE CSS -->
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/bootstrap.min.css}">
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/style.css}">

<link rel="stylesheet" th:href="@{/user/assets/compiled/css/styleMau.css}">

<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<body>
<div id="page">
    <header th:replace="/user/fragments/header :: header"></header>

    <!-- Main Content - Chi tiết sản phẩm -->
    <main>
        <div class="container mt-5 mb-5" th:if="${sanPham != null}">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/fanTech/index">Trang chủ</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Chi tiết sản phẩm</li>
                </ol>
            </nav>

            <div class="row edit py-3" style="background-color: #FFFFFF;">
                <!-- Hình ảnh sản phẩm -->
                <div class="col-md-6">
                    <div>
                        <!-- Sử dụng một img duy nhất, set src động -->
                        <img id="productImage"
                             th:src="${chiTietDauTien?.hinhAnh?.hinhAnh ?: '/user/assets/images/default_product.jpg'}"
                             class="card-img-top"
                             style="height: 400px; object-fit: contain;"
                             th:alt="${sanPham.ten}">
                    </div>
                </div>

                <!-- Thông tin sản phẩm -->
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body px-4 py-3">
                            <!-- Tên sản phẩm -->
                            <h1 class="card-title h3 mb-3 fw-bold text-center text-primary" th:text="${sanPham.ten}">Tên
                                sản phẩm</h1>

                            <!-- Mã sản phẩm + Trạng thái -->
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                                <p class="mb-0 text-muted">
                                    <strong>Mã sản phẩm:</strong>
                                    <span th:text="${sanPham.ma != null ? sanPham.ma : 'Chưa có mã'}">SP001</span>
                                </p>
                                <div>
                                <span class="badge bg-success" th:if="${sanPham.trangThai}">
                                    <i class="fas fa-check-circle me-1"></i>Có sẵn
                                </span>
                                    <span class="badge bg-secondary" th:unless="${sanPham.trangThai}">
                                    <i class="fas fa-times-circle me-1"></i>Hết hàng
                                </span>
                                </div>
                            </div>

                            <!-- Loại quạt -->
                            <div class="mb-3" th:if="${sanPham.kieuQuat != null}">
                                <strong>Loại quạt:</strong>
                                <span class="badge bg-info ms-2" th:text="${sanPham.kieuQuat.ten}">Quạt trần</span>
                            </div>

                            <!-- Chọn màu sắc -->
                            <div class="mb-4"
                                 th:if="${sanPham.sanPhamChiTiet != null and !sanPham.sanPhamChiTiet.isEmpty()}">
                                <h6 class="fw-semibold mb-2">Chọn màu sắc:</h6>
                                <div class="d-flex flex-wrap gap-2" id="colorOptions">
                                    <div th:each="chiTiet, iterStat : ${sanPham.sanPhamChiTiet}">
                                        <input type="radio"
                                               class="btn-check color-option"
                                               th:id="'color-' + ${iterStat.index}"
                                               th:value="${chiTiet.id}"
                                               th:data-color="${chiTiet.mauSac != null ? chiTiet.mauSac.ten : 'Không có'}"
                                               th:data-power="${chiTiet.congSuat != null ? chiTiet.congSuat.ten : 'Không có'}"
                                               name="selectedColor"
                                               autocomplete="off"
                                               th:checked="${iterStat.first}">
                                        <label class="btn btn-outline-primary btn-sm"
                                               th:for="'color-' + ${iterStat.index}"
                                               th:text="${chiTiet.mauSac != null ? chiTiet.mauSac.ten : 'Không có màu'}">
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Chọn công suất -->
                            <div class="mb-4" id="powerSection" style="display: none;">
                                <h6 class="fw-semibold mb-2">Chọn công suất:</h6>
                                <div class="d-flex flex-wrap gap-2" id="powerOptions">
                                    <!-- JavaScript cập nhật -->
                                </div>
                            </div>

                            <!-- Giá -->
                            <div class="mb-4">
                                <h4 class="text-primary fw-bold">
                                    <span id="productPrice"
                                          th:text="${chiTietDauTien != null and chiTietDauTien.gia != null ? #numbers.formatDecimal(chiTietDauTien.gia, 0, 'COMMA', 0, 'POINT') : '0'}">500,000</span>
                                    <small class="text-muted fw-normal">đ</small>
                                </h4>
                            </div>

                            <!-- Số lượng -->
                            <div class="mb-4">
                                <label for="quantity" class="form-label">Số lượng:</label>
                                <div class="input-group" style="max-width: 160px;">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="decreaseQuantity()">-
                                    </button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1"
                                           min="1" max="999">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="increaseQuantity()">+
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1">Số lượng có sẵn: <span
                                        id="availableQuantity">0</span></small>
                            </div>

                            <!-- Nút hành động -->
                            <div class="d-grid gap-2 mb-4">
                                <button class="btn btn-primary btn-lg" id="addToCartBtn" onclick="addToCart()">
                                    <i class="fas fa-shopping-cart me-2"></i> Thêm vào giỏ hàng
                                </button>
                                <a href="/fanTech/index" class="btn btn-outline-dark">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại trang chủ
                                </a>
                            </div>

                        </div>
                    </div>

                </div>
                <div class="col-md-12">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body px-4 py-3">
                            <!-- Mô tả -->
                            <div class="mb-4">
                                <h6 class="fw-semibold mb-2">Mô tả sản phẩm</h6>
                                <p class="text-muted mb-0"
                                   th:text="${sanPham.moTa != null ? sanPham.moTa : 'Chưa có mô tả cho sản phẩm này.'}">
                                    Mô tả sản phẩm sẽ được hiển thị ở đây...
                                </p>
                            </div>

                            <!-- Thông tin chi tiết -->
                            <div class="mb-4" id="productDetails">
                                <h6 class="fw-semibold mb-2">Thông tin chi tiết</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <tbody id="detailsTableBody">
                                        <!-- Thông tin chi tiết sẽ được cập nhật -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Mô tả chi tiết -->
                            <div id="detailedDescription">
                                <h6 class="fw-semibold mb-2">Mô tả chi tiết</h6>
                                <p class="text-muted mb-0" id="detailedDescriptionText">
                                    Mô tả chi tiết của biến thể sản phẩm...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Thông báo khi không tìm thấy sản phẩm -->
        <div class="container mt-5 mb-5" th:unless="${sanPham != null}">
            <div class="text-center">
                <div class="alert alert-warning">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>Không tìm thấy sản phẩm</h4>
                    <p>Sản phẩm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                    <a href="/fanTech/index" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Về trang chủ
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="/user/fragments/footer :: footer"></footer>
</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<!-- Custom JavaScript -->
<script th:inline="javascript">
    // Dữ liệu sản phẩm chi tiết từ Thymeleaf
    const productDetails = /*[[${sanPham.sanPhamChiTiet}]]*/ [];

    // Đối tượng lưu trữ thông tin chi tiết theo ID
    const detailsMap = {};

    // Tạo map từ dữ liệu
    productDetails.forEach(detail => {
        detailsMap[detail.id] = detail;
    });

    // Khởi tạo trang
    document.addEventListener('DOMContentLoaded', function () {
        initializeProductDetails();
        setupColorSelection();
    });

    function initializeProductDetails() {
        // Hiển thị chi tiết của sản phẩm đầu tiên
        const firstDetail = productDetails[0];
        if (firstDetail) {
            updateProductDetails(firstDetail);
        }
    }

    function setupColorSelection() {
        const colorOptionsContainer = document.getElementById('colorOptions');
        const powerSection = document.getElementById('powerSection');

        // Lấy danh sách màu sắc duy nhất
        const uniqueColors = [...new Set(productDetails.map(detail => detail.mauSac?.ten))].filter(color => color);

        // Xóa các tùy chọn màu cũ
        colorOptionsContainer.innerHTML = '';

        // Tạo radio button cho mỗi màu duy nhất
        uniqueColors.forEach((color, index) => {
            const matchingDetails = productDetails.filter(detail => detail.mauSac?.ten === color);
            const defaultDetail = matchingDetails[0]; // Lấy chi tiết đầu tiên làm mặc định

            const div = document.createElement('div');
            div.className = 'col-auto';
            div.innerHTML = `
                <input type="radio" class="btn-check color-option" id="color-${index}" value="${defaultDetail.id}"
                       data-color="${color}" name="selectedColor" autocomplete="off" ${index === 0 ? 'checked' : ''}>
                <label class="btn btn-outline-primary" for="color-${index}">${color}</label>
            `;
            colorOptionsContainer.appendChild(div);

            // Thêm sự kiện thay đổi
            const colorInput = div.querySelector('.color-option');
            colorInput.addEventListener('change', function () {
                if (this.checked) {
                    const selectedDetail = detailsMap[this.value];
                    updateProductDetails(selectedDetail);
                    updatePowerOptions(selectedDetail);
                }
            });
        });

        // Khởi tạo power options cho màu đầu tiên
        if (productDetails[0]) {
            updatePowerOptions(productDetails[0]);
        }
    }

    function updatePowerOptions(selectedDetail) {
        const powerOptions = document.getElementById('powerOptions');
        const powerSection = document.getElementById('powerSection');

        // Lấy tất cả các chi tiết có cùng màu
        const selectedColor = selectedDetail.mauSac?.ten;
        const sameColorDetails = productDetails.filter(detail => detail.mauSac?.ten === selectedColor);

        if (sameColorDetails.length > 1 && [...new Set(sameColorDetails.map(d => d.congSuat?.ten))].length > 1) {
            // Hiển thị các tùy chọn công suất duy nhất
            let html = '';
            const uniquePowers = [...new Set(sameColorDetails.map(detail => detail.congSuat?.ten))].filter(power => power);
            uniquePowers.forEach((power, index) => {
                const matchingDetail = sameColorDetails.find(d => d.congSuat?.ten === power);
                const isSelected = matchingDetail.id === selectedDetail.id;
                html += `
                    <div class="col-auto">
                        <input type="radio" class="btn-check power-option" id="power-${matchingDetail.id}" value="${matchingDetail.id}"
                               name="selectedPower" autocomplete="off" ${isSelected ? 'checked' : ''}
                               onchange="selectPowerOption(${matchingDetail.id})">
                        <label class="btn btn-outline-success" for="power-${matchingDetail.id}">${power}</label>
                    </div>
                `;
            });
            powerOptions.innerHTML = html;
            powerSection.style.display = 'block';
        } else {
            powerSection.style.display = 'none';
        }
    }

    function selectPowerOption(detailId) {
        const detail = detailsMap[detailId];
        if (detail) {
            updateProductDetails(detail);
        }
    }

    function updateProductDetails(detail) {
        // Cập nhật giá
        const priceElement = document.getElementById('productPrice');
        if (detail.gia) {
            priceElement.textContent = new Intl.NumberFormat('vi-VN').format(detail.gia);
        } else {
            priceElement.textContent = '0';
        }

        // Cập nhật số lượng có sẵn
        const availableQuantityElement = document.getElementById('availableQuantity');
        availableQuantityElement.textContent = detail.soLuong || 0;

        // Cập nhật input quantity max
        const quantityInput = document.getElementById('quantity');
        quantityInput.max = detail.soLuong || 1;
        if (parseInt(quantityInput.value) > (detail.soLuong || 1)) {
            quantityInput.value = detail.soLuong || 1;
        }

        // Cập nhật bảng thông tin chi tiết
        updateDetailsTable(detail);

        // Cập nhật mô tả chi tiết
        const descriptionElement = document.getElementById('detailedDescriptionText');
        descriptionElement.textContent = detail.moTa || 'Chưa có mô tả chi tiết cho biến thể này.';

        // Cập nhật trạng thái nút thêm vào giỏ hàng
        updateAddToCartButton(detail);

        // Cập nhật hình ảnh nếu có
        updateProductImage(detail);
    }

    function updateDetailsTable(detail) {
        const tableBody = document.getElementById('detailsTableBody');
        let html = '';

        if (detail.mauSac && detail.mauSac.ten) {
            html += `<tr><td><strong>Màu sắc:</strong></td><td>${detail.mauSac.ten}</td></tr>`;
        }
        if (detail.congSuat && detail.congSuat.ten) {
            html += `<tr><td><strong>Công suất:</strong></td><td>${detail.congSuat.ten}</td></tr>`;
        }
        if (detail.hang && detail.hang.ten) {
            html += `<tr><td><strong>Hãng:</strong></td><td>${detail.hang.ten}</td></tr>`;
        }
        if (detail.nutBam && detail.nutBam.ten) {
            html += `<tr><td><strong>Loại nút bấm:</strong></td><td>${detail.nutBam.ten}</td></tr>`;
        }
        if (detail.canNang) {
            html += `<tr><td><strong>Cân nặng:</strong></td><td>${detail.canNang} g</td></tr>`;
        }
        if (detail.soLuong !== null && detail.soLuong !== undefined) {
            html += `<tr><td><strong>Số lượng có sẵn:</strong></td><td>${detail.soLuong}</td></tr>`;
        }

        tableBody.innerHTML = html;
    }

    function updateAddToCartButton(detail) {
        const addToCartBtn = document.getElementById('addToCartBtn');
        if (detail.soLuong && detail.soLuong > 0 && detail.trangThai !== false) {
            addToCartBtn.disabled = false;
            addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ hàng';
            addToCartBtn.classList.remove('btn-secondary');
            addToCartBtn.classList.add('btn-primary');
        } else {
            addToCartBtn.disabled = true;
            addToCartBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Hết hàng';
            addToCartBtn.classList.remove('btn-primary');
            addToCartBtn.classList.add('btn-secondary');
        }
    }

    function updateProductImage(detail) {
        const productImage = document.getElementById('productImage');
        if (detail.hinhAnh && detail.hinhAnh.hinhAnh) {
            productImage.src = detail.hinhAnh.hinhAnh;
        } else {
            productImage.src = '/user/assets/images/default_product.jpg';
        }
    }

    // Hàm tăng/giảm số lượng
    function increaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const currentValue = parseInt(quantityInput.value);
        const maxValue = parseInt(quantityInput.max);

        if (currentValue < maxValue) {
            quantityInput.value = currentValue + 1;
        }
    }

    function decreaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        const currentValue = parseInt(quantityInput.value);

        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
        }
    }

    // Hàm thêm vào giỏ hàng với kiểm tra giới hạn 100 sản phẩm
    async function addToCart() {
        const selectedColorOption = document.querySelector('input[name="selectedColor"]:checked');
        const selectedPowerOption = document.querySelector('input[name="selectedPower"]:checked');
        const quantity = parseInt(document.getElementById('quantity').value);

        let selectedDetailId;
        if (selectedPowerOption) {
            selectedDetailId = selectedPowerOption.value;
        } else if (selectedColorOption) {
            selectedDetailId = selectedColorOption.value;
        }

        if (!selectedDetailId) {
            showSweetAlert('Vui lòng chọn màu sắc và công suất!', 'warning');
            return;
        }

        const selectedDetail = detailsMap[selectedDetailId];
        if (!selectedDetail) {
            showSweetAlert('Không tìm thấy thông tin sản phẩm!', 'error');
            return;
        }

        if (quantity > selectedDetail.soLuong) {
            showSweetAlert(`Số lượng vượt quá số lượng có sẵn (${selectedDetail.soLuong})!`, 'warning');
            return;
        }

        // Kiểm tra giới hạn 100 sản phẩm
        try {
            const canAdd = await checkCartLimit(selectedDetailId, quantity);
            if (!canAdd) {
                return; // Dừng lại nếu vượt quá giới hạn
            }
        } catch (error) {
            console.error('Error checking cart limit:', error);
            showSweetAlert('Có lỗi xảy ra khi kiểm tra giới hạn giỏ hàng', 'error');
            return;
        }

        const cartItem = {
            id: selectedDetail.id,
            ten: /*[[${sanPham.ten}]]*/ 'Tên sản phẩm',
            mauSac: selectedDetail.mauSac ? selectedDetail.mauSac.ten : 'Không có',
            congSuat: selectedDetail.congSuat ? selectedDetail.congSuat.ten : 'Không có',
            gia: selectedDetail.gia,
            soLuong: quantity,
            hinhAnh: document.getElementById('productImage').src
        };

        addToCartServer(cartItem);
    }

    // Kiểm tra giới hạn 100 sản phẩm trong giỏ hàng
    async function checkCartLimit(sanPhamChiTietId, newQuantity) {
        try {
            const response = await fetch('/cart/info');
            const data = await response.json();
            const currentTotal = data.itemCount || 0;

            // Tìm sản phẩm hiện tại trong giỏ hàng (nếu có)
            const existingItem = data.items.find(item => item.sanPhamChiTietId == sanPhamChiTietId);
            const currentQuantity = existingItem ? existingItem.soLuong : 0;

            // Tính tổng số lượng dự kiến sau khi thêm/cập nhật
            const projectedTotal = currentTotal - currentQuantity + newQuantity;

            // Chặn hoàn toàn nếu tổng số lượng hiện tại đã đạt hoặc vượt 100
            if (currentTotal >= 100) {
                showSweetAlert('Giỏ hàng đã đạt giới hạn 100 sản phẩm! Không thể thêm sản phẩm nào nữa.', 'warning');
                return false;
            }

            // Kiểm tra nếu tổng số lượng dự kiến vượt quá 100
            if (projectedTotal > 100) {
                showSweetAlert(`Giỏ hàng đã đạt giới hạn 100 sản phẩm! Hiện tại có ${currentTotal} sản phẩm, bạn chỉ có thể thêm tối đa ${100 - currentTotal + currentQuantity} sản phẩm.`, 'warning');
                return false;
            }

            return true;
        } catch (error) {
            console.error('Error checking cart limit:', error);
            showSweetAlert('Có lỗi xảy ra khi kiểm tra giới hạn giỏ hàng', 'error');
            return false;
        }
    }

    function addToCartServer(cartItem) {
        const addToCartBtn = document.getElementById('addToCartBtn');
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang thêm...';

        const formData = new FormData();
        formData.append('sanPhamChiTietId', cartItem.id);
        formData.append('soLuong', cartItem.soLuong);

        fetch('/cart/add', {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
            .then(response => response.ok ? response.json() : Promise.reject())
            .then(data => {
                if (data.success) {
                    showSweetAlert('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                    updateCartCount(data.cartCount);
                } else {
                    showSweetAlert(data.message || 'Có lỗi xảy ra!', 'error');
                }
            })
            .catch(() => showSweetAlert('Có lỗi xảy ra khi thêm vào giỏ hàng!', 'error'))
            .finally(() => {
                const selectedDetail = getCurrentSelectedDetail();
                updateAddToCartButton(selectedDetail);
            });
    }

    function getCurrentSelectedDetail() {
        const selectedPowerOption = document.querySelector('input[name="selectedPower"]:checked');
        const selectedColorOption = document.querySelector('input[name="selectedColor"]:checked');
        return selectedPowerOption ? detailsMap[selectedPowerOption.value] : (selectedColorOption ? detailsMap[selectedColorOption.value] : null);
    }

    // Hiển thị thông báo với SweetAlert2
    function showSweetAlert(message, type = 'info', title = 'Thông báo') {
        Swal.fire({
            icon: type,
            title: title,
            text: message,
            position: 'center',
            showConfirmButton: true,
            confirmButtonText: 'OK',
            confirmButtonColor: '#3085d6',
            timer: null, // Loại bỏ tự động đóng
            width: '400px'
        });
    }

    function updateCartCount(count) {
        document.querySelectorAll('.cart-count').forEach(el => {
            el.textContent = count;
            el.style.display = count > 0 ? 'inline' : 'none';
        });
    }

    function toggleUserDropdown(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropdown = document.getElementById('userDropdownMenu');
        document.querySelectorAll('.user-dropdown-menu').forEach(menu => menu.style.display = 'none');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    document.addEventListener('click', () => document.querySelectorAll('.user-dropdown-menu').forEach(menu => menu.style.display = 'none'));

    document.getElementById('quantity').addEventListener('input', function () {
        const value = parseInt(this.value);
        const max = parseInt(this.max);
        const min = parseInt(this.min);
        if (value > max) {
            this.value = max;
            showSweetAlert(`Số lượng tối đa là ${max}`, 'warning');
        } else if (value < min) this.value = min;
    });

    window.addEventListener('resize', () => document.querySelectorAll('.user-dropdown-menu').forEach(menu => menu.style.display = 'none'));

    function initLazyLoading() {
        const lazyImages = document.querySelectorAll('img[data-src]');
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.src = entry.target.dataset.src;
                    entry.target.classList.remove('lazy');
                    observer.unobserve(entry.target);
                }
            }));
            lazyImages.forEach(img => observer.observe(img));
        } else lazyImages.forEach(img => {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
        });
    }

    initLazyLoading();
    document.querySelectorAll('a[href^="#"]').forEach(anchor => anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href'))?.scrollIntoView({behavior: 'smooth', block: 'start'});
    }));
</script>

<!-- ChatAI (Gemini) floating widget for user pages only -->
<script th:src="@{/admin/assets/compiled/js/chat-ai.js}"></script>

</body>
</html>