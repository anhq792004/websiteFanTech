<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}"></head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giỏ Hàng - Shopping Cart</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/bootstrap.min.css}">
<link rel="stylesheet" th:href="@{/user/assets/compiled/css/style.css}">

<!-- Thêm thư viện SweetAlert2 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    /* Tùy chỉnh vị trí thông báo ở góc phải màn hình */
    .swal2-container.swal2-top-end {
        padding: 20px;
        align-items: flex-start;
        justify-content: flex-end;
    }

    .swal2-popup {
        border-radius: 8px;
    }

    /* Tùy chỉnh nút trong thông báo */
    .swal2-styled.swal2-confirm {
        background-color: #0d6efd;
        border-radius: 4px;
    }

    .swal2-styled.swal2-deny {
        background-color: #dc3545;
        border-radius: 4px;
    }

    /* Warning banner for over limit */
    .cart-warning {
        background: linear-gradient(45deg, #fff3cd, #ffeeba);
        border: 2px solid #ffc107;
        border-radius: 10px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
</style>

<body>
<header th:replace="/user/fragments/header :: header"></header>
<!-- Header -->

<main>
    <div class="container p-5">
        <!-- Alert messages -->
        <div id="alertContainer"></div>

        <!-- Over limit warning banner -->
        <div id="overLimitWarning" class="alert cart-warning alert-dismissible fade show mb-4" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-1 col-2 text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                </div>
                <div class="col-md-10 col-8">
                    <h5 class="alert-heading mb-2">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Giỏ hàng đã đạt giới hạn!
                    </h5>
                    <p class="mb-0">
                        Giỏ hàng của bạn hiện có <strong id="currentItemCount">0</strong> sản phẩm, vượt quá giới hạn 100 sản phẩm.
                        Vui lòng giảm số lượng một số sản phẩm để có trải nghiệm tốt nhất.
                    </p>
                </div>
                <div class="col-md-1 col-2">
                    <button type="button" class="btn-close" onclick="document.getElementById('overLimitWarning').style.display='none'"></button>
                </div>
            </div>
        </div>

        <!-- Empty cart message -->
        <div id="emptyCart" class="card text-center py-5" style="display: none;">
            <div class="card-body">
                <i class="fas fa-shopping-cart display-1 text-muted mb-3"></i>
                <h3>Giỏ hàng của bạn đang trống</h3>
                <p class="text-muted">Hãy thêm một số sản phẩm để tiếp tục mua sắm</p>
                <a href="/fanTech/index" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>
                    Tiếp tục mua sắm
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Cart Items -->
                <div id="cartItems">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Cart Summary -->
                <div id="cartSummary" class="card sticky-top">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>
                            Tóm tắt đơn hàng
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span>Số lượng sản phẩm:</span>
                            <span id="totalItems" class="fw-bold">0</span>
                        </div>

                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span>Tạm tính:</span>
                            <span id="subtotal" class="fw-bold">0₫</span>
                        </div>

                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <div>
                                <span>Phí vận chuyển:</span>
                                <small class="text-muted d-block">Miễn phí cho đơn ≥ 2 triệu<br>Dưới 2 triệu:
                                    10k/kg</small>
                            </div>
                            <span id="shippingFee" class="fw-bold">0₫</span>
                        </div>

                        <div class="d-flex justify-content-between mb-4">
                            <strong class="fs-5">Tổng cộng:</strong>
                            <strong id="totalAmount" class="fs-5 text-danger">0₫</strong>
                        </div>

                        <button class="btn btn-success w-100 btn-lg mb-2" id="checkoutBtn">
                            <i class="fas fa-credit-card me-2"></i>
                            Tiến hành thanh toán
                        </button>

                        <button class="btn btn-outline-danger w-100" id="clearCartBtn">
                            <i class="fas fa-trash me-2"></i>
                            Xóa toàn bộ giỏ hàng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="/user/fragments/footer :: footer"></footer>
</body>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    function toggleUserDropdown(event) {
        event.preventDefault();
        const dropdown = document.getElementById('userDropdownMenu');
        dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const dropdown = document.getElementById('userDropdownMenu');
        const button = document.querySelector('.user-info-btn');

        if (dropdown && !dropdown.contains(event.target) && !button.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });

    // Close dropdown when pressing Escape
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            const dropdown = document.getElementById('userDropdownMenu');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
    });
</script>

<script>
    class ShoppingCart {
        constructor() {
            this.init();
        }

        init() {
            this.loadCart();
            this.bindEvents();
        }

        bindEvents() {
            // Clear cart button
            document.getElementById('clearCartBtn').addEventListener('click', () => {
                this.clearCart();
            });

            // Checkout button
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                this.proceedToCheckout();
            });
        }

        async checkTotalLimit(sanPhamChiTietId, newQuantity) {
            try {
                const response = await fetch('/cart/info');
                const data = await response.json();
                const currentTotal = data.itemCount || 0;
                const itemToUpdate = data.items.find(item => item.sanPhamChiTietId === sanPhamChiTietId);
                const currentQuantity = itemToUpdate ? itemToUpdate.soLuong : 0;
                const projectedTotal = currentTotal - currentQuantity + newQuantity;

                if (projectedTotal > 100) {
                    this.showSweetAlert('Giỏ hàng đã đạt giới hạn 100 sản phẩm! Vui lòng giảm số lượng một số sản phẩm khác trước.', 'warning');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error checking cart limit:', error);
                this.showSweetAlert('Có lỗi xảy ra khi kiểm tra giới hạn giỏ hàng', 'error');
                return false;
            }
        }

        async safeUpdateQuantity(sanPhamChiTietId, newQuantity) {
            newQuantity = Number(newQuantity); // Chuyển đổi thành số
            if (newQuantity < 1) {
                this.showSweetAlert('Số lượng phải lớn hơn 0!', 'warning');
                return;
            }

            const canUpdate = await this.checkTotalLimit(sanPhamChiTietId, newQuantity);
            if (canUpdate) {
                this.updateQuantity(sanPhamChiTietId, newQuantity);
            } else {
                // Reset về giá trị cũ nếu vượt giới hạn
                const cartItem = document.querySelector(`[data-id="${sanPhamChiTietId}"] input[type="number"]`);
                if (cartItem) {
                    const currentItem = await (await fetch('/cart/info')).json().items.find(item => item.sanPhamChiTietId === sanPhamChiTietId);
                    cartItem.value = currentItem.soLuong;
                }
            }
        }

        showSweetAlert(message, type = 'success', position = 'center') {
            Swal.fire({
                icon: type,
                title: message,
                position: position,
                showConfirmButton: true,
                confirmButtonText: 'OK',
                customClass: {
                    confirmButton: 'btn btn-primary'
                },
                buttonsStyling: false
            });
        }

        showConfirmAlert(title, text, confirmButtonText, denyButtonText) {
            return Swal.fire({
                title: title,
                text: text,
                icon: 'question',
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: confirmButtonText,
                denyButtonText: denyButtonText,
                customClass: {
                    confirmButton: 'btn btn-primary me-2',
                    denyButton: 'btn btn-outline-secondary'
                },
                buttonsStyling: false
            });
        }

        async loadCart() {
            try {
                const response = await fetch('/cart/info');
                const data = await response.json();

                if (data.isEmpty) {
                    this.showEmptyCart();
                } else {
                    // Luôn render cart items trước
                    this.renderCartItems(data.items);
                    this.updateSummary(data);

                    // Kiểm tra và hiển thị cảnh báo nếu vượt giới hạn
                    if (data.itemCount > 100) {
                        this.showOverLimitWarning(data.itemCount);
                    } else {
                        this.hideOverLimitWarning();
                    }
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                this.showSweetAlert('Có lỗi xảy ra khi tải giỏ hàng', 'error');
            }
        }

        showOverLimitWarning(itemCount) {
            const warningElement = document.getElementById('overLimitWarning');
            const countElement = document.getElementById('currentItemCount');

            if (warningElement && countElement) {
                countElement.textContent = itemCount;
                warningElement.style.display = 'block';
            }
        }

        hideOverLimitWarning() {
            const warningElement = document.getElementById('overLimitWarning');
            if (warningElement) {
                warningElement.style.display = 'none';
            }
        }

        renderCartItems(items) {
            const container = document.getElementById('cartItems');
            const emptyCart = document.getElementById('emptyCart');

            container.innerHTML = '';
            emptyCart.style.display = 'none';

            items.forEach(item => {
                const itemHtml = this.createCartItemHtml(item);
                container.appendChild(itemHtml);
            });
        }

        createCartItemHtml(item) {
            const div = document.createElement('div');
            div.className = 'card mb-3';
            div.setAttribute('data-id', item.sanPhamChiTietId);

            div.innerHTML = `
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-2 col-12 mb-3 mb-md-0">
                    <div class="d-flex justify-content-center">
                        <img src="${item.hinhAnh || '/images/default-product.jpg'}" alt="${item.tenSanPham}" class="img-fluid rounded" style="max-width: 100px; max-height: 100px;">
                    </div>
                </div>
                <div class="col-md-4 col-12 mb-3 mb-md-0">
                    <h5 class="card-title text-primary mb-2">${item.tenSanPham}</h5>
                    <div class="mb-2">
                        ${item.mauSac ? `<span class="badge bg-secondary me-1">Màu: ${item.mauSac}</span>` : ''}
                        ${item.congSuat ? `<span class="badge bg-secondary me-1">Công suất: ${item.congSuat}</span>` : ''}
                        ${item.hang ? `<span class="badge bg-secondary me-1">Hãng: ${item.hang}</span>` : ''}
                    </div>
                    <small class="text-muted">Còn lại: ${item.soLuongTon} sản phẩm</small>
                </div>
                <div class="col-md-2 col-6 mb-3 mb-md-0">
                    <div class="text-center">
                        <div class="fs-5 fw-bold text-danger">${this.formatPrice(item.gia)}</div>
                    </div>
                </div>
                <div class="col-md-4 col-12">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="cart.updateQuantity(${item.sanPhamChiTietId}, ${item.soLuong - 1})"
                                        ${item.soLuong <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="form-control text-center" value="${item.soLuong}"
                                       min="1" max="${item.soLuongTon}"
                                       onchange="cart.safeUpdateQuantity(${item.sanPhamChiTietId}, this.value)">
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="cart.safeUpdateQuantity(${item.sanPhamChiTietId}, ${item.soLuong + 1})"
                                     ${item.soLuong >= item.soLuongTon ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-danger w-100" onclick="cart.removeItem(${item.sanPhamChiTietId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-8 offset-md-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Thành tiền:</span>
                        <span class="fs-5 fw-bold text-danger">${this.formatPrice(item.tongTien)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
            return div;
        }

        async updateQuantity(sanPhamChiTietId, newQuantity) {
            if (newQuantity < 1) return;

            const cartItem = document.querySelector(`[data-id="${sanPhamChiTietId}"]`);
            cartItem.style.opacity = '0.6';
            cartItem.style.pointerEvents = 'none';

            try {
                const formData = new FormData();
                formData.append('sanPhamChiTietId', sanPhamChiTietId);
                formData.append('soLuong', newQuantity);

                const response = await fetch('/cart/update', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    this.loadCart();
                } else {
                    this.showSweetAlert(data.message, 'error');
                    this.loadCart();
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                this.showSweetAlert('Có lỗi xảy ra khi cập nhật số lượng', 'error');
                this.loadCart();
            } finally {
                cartItem.style.opacity = '1';
                cartItem.style.pointerEvents = 'auto';
            }
        }

        async removeItem(sanPhamChiTietId) {
            // Sử dụng SweetAlert thay cho confirm mặc định
            const result = await this.showConfirmAlert(
                'Xác nhận xóa',
                'Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?',
                'Có, xóa sản phẩm',
                'Hủy'
            );

            if (!result.isConfirmed) {
                return;
            }

            const cartItem = document.querySelector(`[data-id="${sanPhamChiTietId}"]`);
            cartItem.style.opacity = '0.6';
            cartItem.style.pointerEvents = 'none';

            try {
                const formData = new FormData();
                formData.append('sanPhamChiTietId', sanPhamChiTietId);

                const response = await fetch('/cart/remove', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    cartItem.remove();
                    this.showSweetAlert(data.message, 'success');

                    if (data.isEmpty) {
                        this.showEmptyCart();
                    } else {
                        this.updateSummaryFromResponse(data);
                        // Kiểm tra và ẩn cảnh báo nếu đã dưới giới hạn
                        if (data.cartCount <= 100) {
                            this.hideOverLimitWarning();
                        }
                    }
                } else {
                    this.showSweetAlert(data.message, 'error');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                this.showSweetAlert('Có lỗi xảy ra khi xóa sản phẩm', 'error');
            } finally {
                cartItem.style.opacity = '1';
                cartItem.style.pointerEvents = 'auto';
            }
        }

        async clearCart() {
            // Sử dụng SweetAlert thay cho confirm mặc định
            const result = await this.showConfirmAlert(
                'Xác nhận xóa',
                'Bạn có chắc chắn muốn xóa toàn bộ giỏ hàng?',
                'Có, xóa toàn bộ',
                'Hủy'
            );

            if (!result.isConfirmed) {
                return;
            }

            try {
                const response = await fetch('/cart/clear', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    this.showEmptyCart();
                    this.hideOverLimitWarning();
                    this.showSweetAlert(data.message, 'success');
                } else {
                    this.showSweetAlert(data.message, 'error');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                this.showSweetAlert('Có lỗi xảy ra khi xóa giỏ hàng', 'error');
            }
        }

        showEmptyCart() {
            document.getElementById('cartItems').innerHTML = '';
            document.getElementById('emptyCart').style.display = 'block';
            document.getElementById('cartSummary').style.display = 'none';
            this.hideOverLimitWarning();
        }

        updateSummary(data) {
            const subtotal = data.totalAmount || 0;
            const totalWeight = data.totalWeight || 0;

            // Tính phí vận chuyển theo logic backend
            let shippingFee = 0;
            if (subtotal < 2000000) {
                const weightKg = totalWeight ? (totalWeight / 1000) : 0;
                shippingFee = Math.ceil(weightKg * 10000);
            } else {
                shippingFee = 0;
            }

            const finalTotal = subtotal + shippingFee;

            document.getElementById('totalItems').textContent = data.itemCount;
            document.getElementById('subtotal').textContent = this.formatPrice(subtotal);
            const shippingElement = document.getElementById('shippingFee');
            if (shippingFee > 0) {
                shippingElement.textContent = this.formatPrice(shippingFee);
                shippingElement.className = 'fw-bold text-warning';
            } else {
                shippingElement.textContent = 'Miễn phí';
                shippingElement.className = 'fw-bold text-success';
            }
            document.getElementById('totalAmount').textContent = this.formatPrice(finalTotal);
            document.getElementById('cartSummary').style.display = 'block';
        }

        updateSummaryFromResponse(data) {
            this.updateSummary({
                itemCount: data.cartCount,
                totalAmount: data.totalAmount
            });
        }

        proceedToCheckout() {
            // Redirect to checkout page
            window.location.href = '/checkout';
        }

        formatPrice(price) {
            if (!price) return '0₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
    }

    // Initialize cart when page loads
    const cart = new ShoppingCart();
</script>

</html>