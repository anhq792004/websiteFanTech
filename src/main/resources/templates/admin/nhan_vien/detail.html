<!DOCTYPE html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}"></head>
<body>
<!-- Site wrapper -->
<div class="wrapper">
    <!-- Sidebar -->
    <div>
        <aside th:replace="/admin/fragments/sidebar :: sidebar"></aside>
    </div>

    <!-- Main-->
    <div id="main">
        <header th:replace="/admin/fragments/header :: header"></header>
        <div class="page-content">
            <!--        dữ liệu thực hiện trong secsion-->
            <section class="row">
                <div class="card">
                    <form id="formUpdateNV" th:object="${nhanVien}">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2>Thông tin nhân viên</h2>
                                <button type="submit" class="btn btn-outline-warning">
                                    <i class="bi bi-pencil-square"></i> Lưu
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row justify-content-around">
                                <input type="hidden" name="id" id="id" th:value="${nhanVien.id}">
                                <div class="col-md-4">
                                    <!-- Input file ẩn để lưu ảnh -->
                                    <input type="file" id="hinhAnh" name="hinhAnh" accept="image/*" style="display: none;">
                                    
                                    <!-- Ảnh tròn có thể click -->
                                    <div class="text-center mb-3">
                                        <img th:src="${nhanVien.anh != null and nhanVien.anh != '' ? nhanVien.anh : '/admin/assets/images/avatar.jpg'}" 
                                             alt="Avatar" class="img-fluid rounded-circle mb-2" id="employeeAvatar"
                                             style="width: 120px; height: 120px; object-fit: cover; cursor: pointer; transition: all 0.3s ease;"
                                             title="Click để thay đổi ảnh nhân viên"
                                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'"
                                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                        <div class="form-text">Click vào ảnh để thay đổi ảnh nhân viên</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold"><span class="text-danger">*</span> Tên nhân
                                            viên</label>
                                        <input class="form-control" id="name" th:value="${nhanVien.ten}" required>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold"><span class="text-danger">*</span>
                                            Email</label>
                                        <input class="form-control" th:value="${nhanVien.taiKhoan.email}" type="email"
                                               disabled required>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold"><span class="text-danger">*</span> Số Điện
                                                Thoại</label>
                                            <input class="form-control" id="soDienThoai"
                                                   th:value="${nhanVien.soDienThoai}"
                                                   type="tel" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="canCuocCongDan" class="form-label fw-bold"><span
                                                    class="text-danger">*</span> Số CCCD</label>
                                            <input type="text" class="form-control" id="canCuocCongDan"
                                                   th:value="${nhanVien.canCuocCongDan}" name="soCCCD" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="mb-3 col-md-4">
                                            <label class="form-label fw-bold"><span class="text-danger">*</span> Ngày
                                                sinh</label>
                                            <input type="text" class="form-control flatpickr" id="ngaySinh"
                                                   name="ngaySinh" placeholder="Ngày sinh"
                                                   th:value="${ngaySinhFormatted}" required>

                                        </div>
                                        <div class="mb-3 col-md-4">
                                            <label for="gioiTinh" class="form-label fw-bold">Giới tính</label>
                                            <select class="form-select" id="gioiTinh" name="gioiTinh" required>
                                                <option value="Nam" th:selected="${nhanVien.gioiTinh == 'Nam'}">Nam
                                                </option>
                                                <option value="Nữ" th:selected="${nhanVien.gioiTinh == 'Nữ'}">Nữ
                                                </option>
                                            </select>
                                        </div>
                                        <div class="mb-3 col-md-4">
                                            <label for="chucVu" class="form-label fw-bold">Chức vụ</label>
                                            <select class="form-select" id="chucVu" name="chucVu" required>
                                                <option value="Employe"
                                                        th:selected="${nhanVien.chucVu.viTri == 'Employe'}">Nhân viên
                                                </option>
                                                <option value="Admin" th:selected="${nhanVien.chucVu.viTri == 'Admin'}">
                                                    Admin
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <!-- Tỉnh/Thành phố -->
                                        <div class="col ">
                                            <label class="form-label fw-bold" for="city"><span
                                                    class="text-danger">*</span> Tỉnh/Thành phố</label>
                                            <select class="form-control" id="city" name="tinh_thanh_pho">
                                                <option value="">Chọn tỉnh thành</option>
                                            </select>
                                        </div>
                                        <!-- Quận/Huyện -->
                                        <div class="col ">
                                            <label class="form-label fw-bold" for="district"><span
                                                    class="text-danger">*</span> Quận/Huyện</label>
                                            <select class="form-control" id="district" name="quan_huyen">
                                                <option value="">Chọn quận huyện</option>
                                            </select>
                                        </div>

                                        <!-- Phường/Xã -->
                                        <div class="col ">
                                            <label class="form-label fw-bold" for="ward"><span
                                                    class="text-danger">*</span> Phường/Xã</label>
                                            <select class="form-control" id="ward" name="xa_phuong">
                                                <option value="">Chọn phường xã</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="soNhaNgoDuong" class="form-label fw-bold"><span
                                                class="text-danger">*</span> Địa Chỉ Cụ Thể</label>
                                        <input type="text" class="form-control" id="soNhaNgoDuong"
                                               name="soNhaNgoDuong" th:value="${nhanVien.diaChi.soNhaNgoDuong}"
                                               required>
                                    </div>
                                    <!-- Dữ liệu ẩn từ Thymeleaf -->
                                    <input type="hidden" id="tinh" th:value="${nhanVien.diaChi.tinh}"/>
                                    <input type="hidden" id="huyen" th:value="${nhanVien.diaChi.huyen}"/>
                                    <input type="hidden" id="xa" th:value="${nhanVien.diaChi.xa}"/>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

        </div>
    </div>
    <!-- Footer-->
    <div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>
<div>
    <script th:replace="/admin/fragments/script :: script"></script>
    <script th:src="@{/admin/assets/compiled/js/nhanVien.js}"></script>

    <script th:inline="javascript">
        $(document).ready(function () {
            $('#formUpdateNV').on('submit', function (event) {
                event.preventDefault();

                // Lấy giá trị các trường
                const id = $('#id').val().trim();
                const ten = $('#name').val().trim();
                const sdt = $('#soDienThoai').val().trim();
                const cccd = $('#canCuocCongDan').val().trim();
                const ngaySinh = $('#ngaySinh').val().trim();
                const tinhThanhPho = $('#city').val().trim();
                const quanHuyen = $('#district').val().trim();
                const xaPhuong = $('#ward').val().trim();
                const soNhaNgoDuong = $('#soNhaNgoDuong').val().trim();
                const gioiTinh = $('#gioiTinh').val().trim();
                const chucVu = $('#chucVu').val().trim();
                const hinhAnhFile = $('#hinhAnh')[0].files[0];

                // Kiểm tra các trường bắt buộc
                if (!ten) {
                    showToast('error', 'Vui lòng nhập tên nhân viên');
                    return;
                }
                if (ten.length > 100) {
                    showToast('error', 'Tên không được dài quá 100 ký tự');
                    return;
                }
                if (!sdt) {
                    showToast('error', 'Vui lòng nhập số điện thoại');
                    return;
                }
                if (!isValidPhoneNumber(sdt)) {
                    showToast('error', 'Số điện thoại phải có từ 10 đến 12 chữ số');
                    return;
                }
                if (!cccd) {
                    showToast('error', 'Vui lòng nhập số CCCD');
                    return;
                }
                if (!isValidCCCD(cccd)) {
                    showToast('error', 'Số CCCD phải có 12 chữ số');
                    return;
                }
                if (!ngaySinh) {
                    showToast('error', 'Vui lòng nhập ngày sinh');
                    return;
                }
                if (!isValidDate(ngaySinh)) {
                    showToast('error', 'Ngày sinh không hợp lệ hoặc trong tương lai');
                    return;
                }
                if (!tinhThanhPho) {
                    showToast('error', 'Vui lòng chọn Tỉnh/Thành phố');
                    return;
                }
                if (!quanHuyen) {
                    showToast('error', 'Vui lòng chọn Quận/Huyện');
                    return;
                }
                if (!xaPhuong) {
                    showToast('error', 'Vui lòng chọn Xã/Phường');
                    return;
                }
                if (!soNhaNgoDuong) {
                    showToast('error', 'Vui lòng nhập địa chỉ cụ thể');
                    return;
                }
                if (soNhaNgoDuong.length > 100) {
                    showToast('error', 'Địa chỉ cụ thể không được dài quá 100 ký tự');
                    return;
                }
                if (!gioiTinh) {
                    showToast('error', 'Vui lòng chọn giới tính');
                    return;
                }
                if (!chucVu) {
                    showToast('error', 'Vui lòng chọn chức vụ');
                    return;
                }
                // Kiểm tra file ảnh nếu có
                if (hinhAnhFile) {
                    if (!hinhAnhFile.type.startsWith('image/')) {
                        showToast('error', 'Vui lòng chọn file hình ảnh hợp lệ');
                        return;
                    }
                    if (hinhAnhFile.size > 5 * 1024 * 1024) {
                        showToast('error', 'Kích thước file không được vượt quá 5MB');
                        return;
                    }
                }

                // Vô hiệu hóa nút và hiển thị spinner
                const $submitBtn = $('button[type="submit"]');
                $submitBtn.prop('disabled', true);
                $submitBtn.find('.bi-pencil-square').addClass('d-none');
                $submitBtn.append('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>');

                // Hiển thị loading SweetAlert2
                Swal.fire({
                    title: 'Đang xử lý...',
                    html: 'Vui lòng chờ trong giây lát',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Tạo FormData để gửi cả text và file
                const formData = new FormData();
                formData.append('id', id);
                formData.append('ten', ten);
                formData.append('soDienThoai', sdt);
                formData.append('canCuocCongDan', cccd);
                formData.append('ngaySinh', ngaySinh);
                formData.append('gioiTinh', gioiTinh);
                formData.append('tinhThanhPho', tinhThanhPho);
                formData.append('quanHuyen', quanHuyen);
                formData.append('xaPhuong', xaPhuong);
                formData.append('soNhaNgoDuong', soNhaNgoDuong);
                formData.append('chucVu', chucVu);
                if (hinhAnhFile) {
                    formData.append('hinhAnh', hinhAnhFile);
                }

                // Gửi AJAX request
                $.ajax({
                    url: '/admin/nhan-vien/update',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        Swal.fire({
                            toast: true,
                            icon: 'success',
                            title: response.message || 'Cập nhật thông tin nhân viên thành công',
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true
                        }).then(() => {
                            window.location.href = '/admin/nhan-vien/index';
                        });
                    },
                    error: function (xhr) {
                        Swal.close();
                        showToast('error', xhr.responseText || 'Lỗi khi cập nhật thông tin nhân viên');
                        $submitBtn.prop('disabled', false);
                        $submitBtn.find('.spinner-border').remove();
                        $submitBtn.find('.bi-pencil-square').removeClass('d-none');
                    }
                });
            });
        });
    </script>

</div>
</body>
</html>
