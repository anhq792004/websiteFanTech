<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}">
    <title>Thống kê doanh thu</title>
    <link rel="stylesheet" th:href="@{/admin/assets/compiled/css/bootstrap.min.css}"/>
    <style>
        .card-summary { min-height: 110px; }
    </style>
</head>
<body>
<div class="wrapper">
    <div th:replace="/admin/fragments/sidebar :: sidebar"></div>
    <div id="main">
        <header th:replace="/admin/fragments/header :: header"></header>
        <div class="page-content">
            <section class="row">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Thống kê doanh thu</h5>
                    </div>
                    <div class="card-body">
                        <!-- Card tổng quan -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e3f0ff; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #3b5998;">Tổng doanh thu</h6>
                                        <h3 id="cardTongDoanhThu" style="color: #3b5998;">0 đ</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e6f9f0; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #1abc9c;">Doanh thu hôm nay</h6>
                                        <h3 id="cardDoanhThuHomNay" style="color: #1abc9c;">0 VND</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #f0f7fa; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #2980b9;">Doanh thu tuần này</h6>
                                        <h3 id="cardDoanhThuTuanNay" style="color: #2980b9;">0 VND</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #fff7e6; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #f39c12;">Doanh thu tháng này</h6>
                                        <h3 id="cardDoanhThuThangNay" style="color: #f39c12;">0 VND</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card thống kê khác -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardPhieuGiamGiaContainer" style="background: #e8f5e8; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #28a745;">Phiếu giảm giá</h6>
                                        <h3 id="cardPhieuGiamGia" style="color: #28a745;">0</h3>
                                        <small class="text-muted">Đang hoạt động</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardBanChayContainer" style="background: #fff3cd; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #ffc107;">Sản phẩm bán chạy</h6>
                                        <h3 id="cardSanPhamBanChay" style="color: #ffc107;">0</h3>
                                        <small class="text-muted">Top 5 tháng này</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardHetHangContainer" style="background: #f8d7da; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #dc3545;">Sản phẩm hết hàng</h6>
                                        <h3 id="cardSanPhamHetHang" style="color: #dc3545;">0</h3>
                                        <small class="text-muted">Cần nhập thêm</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e3f0ff; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #3b5998;">Tổng đơn hàng</h6>
                                        <h3 id="cardTongDonHang" style="color: #3b5998;">0</h3>
                                        <small class="text-muted">Tất cả trạng thái</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card trạng thái đơn hàng -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Thống kê trạng thái đơn hàng</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartTrangThaiDonHang" style="max-height: 400px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Biểu đồ doanh thu từng ngày trong tháng -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Doanh thu theo từng ngày:</span>
                                    <select id="selectMonth" class="form-select w-auto me-2"></select>
                                    <select id="selectYear" class="form-select w-auto"></select>
                                </div>
                                <canvas id="chartNgay"></canvas>
                            </div>
                            <!-- Biểu đồ doanh thu từng tháng trong năm -->
                            <div class="col-md-6">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Doanh thu theo từng tháng:</span>
                                    <select id="selectYearThang" class="form-select w-auto"></select>
                                </div>
                                <canvas id="chartThang"></canvas>
                            </div>
                        </div>
                        <!-- Biểu đồ doanh thu theo khoảng ngày -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Theo khoảng thời gian:</span>
                                    <input type="date" id="fromDate" class="form-control w-auto me-2"/>
                                    <input type="date" id="toDate" class="form-control w-auto me-2"/>
                                    <button class="btn btn-primary" id="btnKhoang">Áp dụng</button>
                                </div>
                                <canvas id="chartKhoang"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>

<!-- Custom Modal: Top bán chạy -->
<div id="modalTopBanChay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1055;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:8px; width:90%; max-width:1000px; max-height:80%; overflow:auto;">
        <div style="padding:20px; border-bottom:1px solid #dee2e6; display:flex; justify-content:space-between; align-items:center;">
            <h5 style="margin:0;">Danh sách sản phẩm bán chạy</h5>
            <button id="closeBanChay" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;">
            <div class="mb-3 d-flex gap-2 align-items-center flex-wrap">
                <button class="btn btn-outline-primary" data-scope="day">Ngày</button>
                <button class="btn btn-outline-primary" data-scope="week">Tuần</button>
                <button class="btn btn-outline-primary" data-scope="month">Tháng</button>
                <button class="btn btn-outline-primary" data-scope="custom">Tùy chỉnh</button>
                <input type="date" id="topFrom" class="form-control w-auto" style="display:none;">
                <input type="date" id="topTo" class="form-control w-auto" style="display:none;">
                <button id="btnApplyCustomTop" class="btn btn-primary" style="display:none;">Lọc</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Giá tiền</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyTopBanChay"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Custom Modal: Sắp hết hàng -->
<div id="modalSapHetHang" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1055;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:8px; width:90%; max-width:1000px; max-height:80%; overflow:auto;">
        <div style="padding:20px; border-bottom:1px solid #dee2e6; display:flex; justify-content:space-between; align-items:center;">
            <h5 style="margin:0;">Danh sách sản phẩm sắp hết hàng</h5>
            <button id="closeSapHet" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;">
            <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
                <span style="color: #000; font-weight: 500;">Ngưỡng cảnh báo (≤ số lượng):</span>
                <input type="number" id="inpThreshold" class="form-control w-auto" value="10" min="1" title="Hiển thị sản phẩm có số lượng nhỏ hơn hoặc bằng giá trị này">
                <span style="color: #000; font-weight: 500;">Số lượng hiển thị:</span>
                <input type="number" id="inpLimit" class="form-control w-auto" value="10" min="1" title="Số sản phẩm tối đa hiển thị trong danh sách">
                <button id="btnReloadLow" class="btn btn-primary">Tải lại</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Giá</th>
                            <th>Thuộc tính</th>
                        </tr>
                    </thead>
                    <tbody id="tbodySapHetHang"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.6/jquery.simplePagination.min.js"></script>
<!-- Load scripts -->
<script th:src="@{/admin/assets/compiled/js/chart.umd.min.js}"></script>


<script>
window.addEventListener('load', function() {
    console.log('Page loaded, checking Chart.js...');
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        alert('Lỗi: Chart.js không được load. Vui lòng refresh trang.');
        return;
    }
    console.log('Chart.js loaded successfully:', Chart.version);

    // Card tổng quan
    async function loadCardTongQuan() {
        console.log('Loading card tổng quan...');
        const res = await fetch('/api/thong-ke/doanh-thu-tong-hop');
        const data = res.ok ? await res.json() : {};
        console.log('Card tổng quan data:', data);
        document.getElementById('cardTongDoanhThu').textContent = data.tongDoanhThu?.toLocaleString() + ' VND' || '0 VND';
        document.getElementById('cardDoanhThuHomNay').textContent = data.doanhThuHomNay?.toLocaleString() + ' VND' || '0 VND';
        document.getElementById('cardDoanhThuTuanNay').textContent = data.doanhThuTuanNay?.toLocaleString() + ' VND' || '0 VND';
        document.getElementById('cardDoanhThuThangNay').textContent = data.doanhThuThangNay?.toLocaleString() + ' VND' || '0 VND';
    }
    
    // Load trạng thái đơn hàng
    async function loadTrangThaiDonHang() {
        console.log('Loading trạng thái đơn hàng...');
        const res = await fetch('/api/thong-ke/trang-thai-don-hang');
        const data = res.ok ? await res.json() : {};
        console.log('Trạng thái đơn hàng data:', data);
        
        // Tạo biểu đồ tròn
        const chartData = {
            labels: ['Đang giao hàng', 'Đã hủy', 'Hoàn thành'],
            datasets: [{
                data: [data.dangGiaoHang || 0, data.daHuy || 0, data.hoanThanh || 0],
                backgroundColor: [
                    '#fff3cd', // Vàng nhạt cho đang giao hàng
                    '#f8d7da', // Đỏ nhạt cho đã hủy
                    '#d1edff'  // Xanh nhạt cho hoàn thành
                ],
                borderColor: [
                    '#856404', // Vàng đậm
                    '#721c24', // Đỏ đậm
                    '#0c5460'  // Xanh đậm
                ],
                borderWidth: 2
            }]
        };
        
        if (chartTrangThaiDonHang) {
            chartTrangThaiDonHang.destroy();
        }
        
        chartTrangThaiDonHang = new Chart(document.getElementById('chartTrangThaiDonHang').getContext('2d'), {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} đơn hàng (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Load thống kê khác
    async function loadThongKeKhac() {
        console.log('Loading thống kê khác...');
        const res = await fetch('/api/thong-ke/thong-ke-khac');
        const data = res.ok ? await res.json() : {};
        console.log('Thống kê khác data:', data);
        
        document.getElementById('cardPhieuGiamGia').textContent = data.phieuGiamGia || '0';
        document.getElementById('cardSanPhamBanChay').textContent = data.sanPhamBanChay || '0';
        document.getElementById('cardSanPhamHetHang').textContent = data.sanPhamHetHang || '0';
        document.getElementById('cardTongDonHang').textContent = data.tongDonHang || '0';
    }
    // Helper: fill select tháng/năm
    function fillMonthYearSelects() {
        const now = new Date();
        const selectMonth = document.getElementById('selectMonth');
        const selectYear = document.getElementById('selectYear');
        const selectYearThang = document.getElementById('selectYearThang');
        selectMonth.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            selectMonth.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>Tháng ${m}</option>`;
        }
        selectYear.innerHTML = '';
        selectYearThang.innerHTML = '';
        for (let y = now.getFullYear() - 5; y <= now.getFullYear() + 1; y++) {
            selectYear.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
            selectYearThang.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
        }
    }
    // Chart.js instance
    let chartNgay, chartThang, chartKhoang, chartTrangThaiDonHang;
    // Load chart doanh thu từng ngày trong tháng
    async function loadChartNgay() {
        console.log('Loading chart ngày...');
        const month = document.getElementById('selectMonth').value;
        const year = document.getElementById('selectYear').value;
        const res = await fetch(`/api/thong-ke/doanh-thu-ngay-trong-thang?year=${year}&month=${month}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart ngày data:', data);
        const labels = data.map(d => d.ngay);
        const values = data.map(d => d.tongDoanhThu);
        if (chartNgay) chartNgay.destroy();
        chartNgay = new Chart(document.getElementById('chartNgay').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(59,89,152,0.8)',
                    borderColor: '#3b5998',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' VND';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart ngày created successfully');
    }
    // Load chart doanh thu từng tháng trong năm
    async function loadChartThang() {
        console.log('Loading chart tháng...');
        const year = document.getElementById('selectYearThang').value;
        const res = await fetch(`/api/thong-ke/doanh-thu-thang-trong-nam?year=${year}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart tháng data:', data);
        const labels = data.map(d => 'Tháng ' + d.thang);
        const values = data.map(d => d.tongDoanhThu);
        if (chartThang) chartThang.destroy();
        chartThang = new Chart(document.getElementById('chartThang').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(26,188,156,0.8)',
                    borderColor: '#1abc9c',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' VND';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart tháng created successfully');
    }
    // Load chart doanh thu theo khoảng ngày
    async function loadChartKhoang() {
        console.log('Loading chart khoảng...');
        const from = document.getElementById('fromDate').value;
        const to = document.getElementById('toDate').value;
        if (!from || !to) return;
        const res = await fetch(`/api/thong-ke/doanh-thu-theo-khoang?from=${from}&to=${to}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart khoảng data:', data);
        const labels = data.map(d => d.ngay);
        const values = data.map(d => d.tongDoanhThu);
        if (chartKhoang) chartKhoang.destroy();
        chartKhoang = new Chart(document.getElementById('chartKhoang').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(243,156,18,0.8)',
                    borderColor: '#f39c12',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' VND';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart khoảng created successfully');
    }
    // Sự kiện
    console.log('Initializing charts...');
    fillMonthYearSelects();
    loadCardTongQuan();
    loadTrangThaiDonHang(); // Call the new function here
    loadThongKeKhac(); // Call the new function here
    loadChartNgay();
    loadChartThang();
    document.getElementById('selectMonth').onchange = loadChartNgay;
    document.getElementById('selectYear').onchange = loadChartNgay;
    document.getElementById('selectYearThang').onchange = loadChartThang;
    document.getElementById('btnKhoang').onclick = loadChartKhoang;
    console.log('Charts initialized successfully');

    // Gắn sự kiện click card để mở modal custom
    const cardBanChay = document.getElementById('cardBanChayContainer');
    if (cardBanChay) {
        cardBanChay.addEventListener('click', function(){
            document.getElementById('modalTopBanChay').style.display = 'block';
            loadTopBanChay('day');
        });
    }
    const cardHetHang = document.getElementById('cardHetHangContainer');
    if (cardHetHang) {
        cardHetHang.addEventListener('click', function(){
            document.getElementById('modalSapHetHang').style.display = 'block';
            loadSapHetHang();
        });
    }
    
    // Nút đóng modal
    const closeBanChay = document.getElementById('closeBanChay');
    if (closeBanChay) {
        closeBanChay.addEventListener('click', function(){
            document.getElementById('modalTopBanChay').style.display = 'none';
        });
    }
    const closeSapHet = document.getElementById('closeSapHet');
    if (closeSapHet) {
        closeSapHet.addEventListener('click', function(){
            document.getElementById('modalSapHetHang').style.display = 'none';
        });
    }

    // Nút filter trong modal Top bán chạy
    const scopeBtns = document.querySelectorAll('#modalTopBanChay [data-scope]');
    if (scopeBtns && scopeBtns.length) {
        scopeBtns.forEach(btn => {
            btn.addEventListener('click', ()=>{
                const scope = btn.getAttribute('data-scope');
                const topFrom = document.getElementById('topFrom');
                const topTo = document.getElementById('topTo');
                const btnApply = document.getElementById('btnApplyCustomTop');
                if(scope==='custom'){
                    if (topFrom) topFrom.style.display='block';
                    if (topTo) topTo.style.display='block';
                    if (btnApply) btnApply.style.display='block';
                } else {
                    if (topFrom) topFrom.style.display='none';
                    if (topTo) topTo.style.display='none';
                    if (btnApply) btnApply.style.display='none';
                    loadTopBanChay(scope);
                }
            });
        });
    }
    const btnApplyCustomTop = document.getElementById('btnApplyCustomTop');
    if (btnApplyCustomTop) {
        btnApplyCustomTop.addEventListener('click', ()=>{
            const from = document.getElementById('topFrom')?.value;
            const to = document.getElementById('topTo')?.value;
            if(from && to){
                loadTopBanChay('custom', from, to);
            }
        });
    }

    async function loadTopBanChay(scope, from, to){
        const params = new URLSearchParams({scope});
        if(scope==='custom' && from && to){ params.append('from', from); params.append('to', to); }
        const res = await fetch(`/api/thong-ke/top-ban-chay?${params.toString()}`);
        const data = res.ok ? await res.json() : [];
        const tbody = document.getElementById('tbodyTopBanChay');
        if (!tbody) return;
        tbody.innerHTML = '';
        if(!data.length){
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No Data Found</td></tr>';
            return;
        }
        data.forEach((row, idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${row.tenSanPham}</td><td>${row.soLuongBan}</td><td>${(row.tongTien||0).toLocaleString('vi-VN')} đ</td>`;
            tbody.appendChild(tr);
        });
    }

    const btnReloadLow = document.getElementById('btnReloadLow');
    if (btnReloadLow) {
        btnReloadLow.addEventListener('click', loadSapHetHang);
    }
    async function loadSapHetHang(){
        const thresholdEl = document.getElementById('inpThreshold');
        const limitEl = document.getElementById('inpLimit');
        const threshold = thresholdEl ? (thresholdEl.value || 10) : 10;
        const limit = limitEl ? (limitEl.value || 10) : 10;
        const res = await fetch(`/api/thong-ke/sap-het-hang?threshold=${threshold}&limit=${limit}`);
        const data = res.ok ? await res.json() : [];
        const tbody = document.getElementById('tbodySapHetHang');
        if (!tbody) return;
        tbody.innerHTML = '';
        if(!data.length){
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No Data Found</td></tr>';
            return;
        }
        data.forEach((row, idx)=>{
            const img = row.hinhAnh ? `<img src="${row.hinhAnh}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;"/>` : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${img}</td><td>${row.tenSanPham||''}</td><td>${row.soLuong||0}</td><td>${(row.gia||0).toLocaleString('vi-VN')} đ</td><td>${row.thuocTinh||''}</td>`;
            tbody.appendChild(tr);
        });
    }
});
</script>
</body>
</html> 