<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}">
    <title>Th·ªëng k√™ doanh thu</title>
    <link rel="stylesheet" th:href="@{/admin/assets/compiled/css/bootstrap.min.css}"/>
    <style>
        .card-summary { min-height: 110px; }
        .clickable-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .clickable-card::after {
            content: 'üëÜ Click ƒë·ªÉ xem chi ti·∫øt';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .clickable-card:hover::after {
            opacity: 1;
        }
        
        /* Submenu styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .submenu.submenu-open {
            max-height: 500px;
        }
        
        .submenu.submenu-closed {
            max-height: 0;
        }
        
        .submenu-item {
            padding-left: 2rem;
        }
        
        .submenu-link {
            display: block;
            padding: 0.5rem 1rem;
            color: #6c757d;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .submenu-link:hover {
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div th:replace="/admin/fragments/sidebar :: sidebar"></div>
    <div id="main">
        <header th:replace="/admin/fragments/header :: header"></header>
        <div class="page-content">
            <section class="row">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Th·ªëng k√™ doanh thu</h5>
                    </div>
                    <div class="card-body">
                        <!-- Card t·ªïng quan -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e3f0ff; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #3b5998;">T·ªïng doanh thu</h6>
                                        <h3 id="cardTongDoanhThu" style="color: #3b5998;">0 ƒë</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e6f9f0; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #1abc9c;">Doanh thu h√¥m nay</h6>
                                        <h3 id="cardDoanhThuHomNay" style="color: #1abc9c;">0 ƒë</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #f0f7fa; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #2980b9;">Doanh thu tu·∫ßn n√†y</h6>
                                        <h3 id="cardDoanhThuTuanNay" style="color: #2980b9;">0 ƒë</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #fff7e6; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #f39c12;">Doanh thu th√°ng n√†y</h6>
                                        <h3 id="cardDoanhThuThangNay" style="color: #f39c12;">0 ƒë</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card th·ªëng k√™ kh√°c -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardPhieuGiamGiaContainer" style="background: #e8f5e8; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #28a745;">Phi·∫øu gi·∫£m gi√°</h6>
                                        <h3 id="cardPhieuGiamGia" style="color: #28a745;">0</h3>
                                        <small class="text-muted">ƒêang ho·∫°t ƒë·ªông</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardBanChayContainer" style="background: #fff3cd; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #ffc107;">S·∫£n ph·∫©m b√°n ch·∫°y</h6>
                                        <h3 id="cardSanPhamBanChay" style="color: #ffc107;">0</h3>
                                        <small class="text-muted">Top 5 th√°ng n√†y</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" id="cardHetHangContainer" style="background: #f8d7da; border: none; cursor:pointer;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #dc3545;">S·∫£n ph·∫©m h·∫øt h√†ng</h6>
                                        <h3 id="cardSanPhamHetHang" style="color: #dc3545;">0</h3>
                                        <small class="text-muted">C·∫ßn nh·∫≠p th√™m</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-summary mb-3" style="background: #e3f0ff; border: none;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title" style="color: #3b5998;">T·ªïng ƒë∆°n h√†ng</h6>
                                        <h3 id="cardTongDonHang" style="color: #3b5998;">0</h3>
                                        <small class="text-muted">T·∫•t c·∫£ tr·∫°ng th√°i</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card tr·∫°ng th√°i ƒë∆°n h√†ng -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Th·ªëng k√™ tr·∫°ng th√°i ƒë∆°n h√†ng</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartTrangThaiDonHang" style="max-height: 400px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bi·ªÉu ƒë·ªì doanh thu t·ª´ng ng√†y trong th√°ng -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Doanh thu theo t·ª´ng ng√†y:</span>
                                    <select id="selectMonth" class="form-select w-auto me-2"></select>
                                    <select id="selectYear" class="form-select w-auto"></select>
                                </div>
                                <canvas id="chartNgay"></canvas>
                            </div>
                            <!-- Bi·ªÉu ƒë·ªì doanh thu t·ª´ng th√°ng trong nƒÉm -->
                            <div class="col-md-6">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Doanh thu theo t·ª´ng th√°ng:</span>
                                    <select id="selectYearThang" class="form-select w-auto"></select>
                                </div>
                                <canvas id="chartThang"></canvas>
                            </div>
                        </div>
                        <!-- Bi·ªÉu ƒë·ªì doanh thu theo kho·∫£ng ng√†y -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-2 d-flex align-items-center">
                                    <span class="me-2">Theo kho·∫£ng th·ªùi gian:</span>
                                    <input type="date" id="fromDate" class="form-control w-auto me-2"/>
                                    <input type="date" id="toDate" class="form-control w-auto me-2"/>
                                    <button class="btn btn-primary" id="btnKhoang">√Åp d·ª•ng</button>
                                </div>
                                <canvas id="chartKhoang"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>

<!-- Custom Modal: Top b√°n ch·∫°y -->
<div id="modalTopBanChay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1055;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:8px; width:90%; max-width:1000px; max-height:80%; overflow:auto;">
        <div style="padding:20px; border-bottom:1px solid #dee2e6; display:flex; justify-content:space-between; align-items:center;">
            <h5 style="margin:0;">Danh s√°ch s·∫£n ph·∫©m b√°n ch·∫°y</h5>
            <button id="closeBanChay" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;">
            <div class="mb-3 d-flex gap-2 align-items-center flex-wrap">
                <button class="btn btn-outline-primary" data-scope="day">Ng√†y</button>
                <button class="btn btn-outline-primary" data-scope="week">Tu·∫ßn</button>
                <button class="btn btn-outline-primary" data-scope="month">Th√°ng</button>
                <button class="btn btn-outline-primary" data-scope="custom">T√πy ch·ªânh</button>
                <input type="date" id="topFrom" class="form-control w-auto" style="display:none;">
                <input type="date" id="topTo" class="form-control w-auto" style="display:none;">
                <button id="btnApplyCustomTop" class="btn btn-primary" style="display:none;">L·ªçc</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√° ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyTopBanChay"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Custom Modal: S·∫Øp h·∫øt h√†ng -->
<div id="modalSapHetHang" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1055;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:8px; width:90%; max-width:1000px; max-height:80%; overflow:auto;">
        <div style="padding:20px; border-bottom:1px solid #dee2e6; display:flex; justify-content:space-between; align-items:center;">
            <h5 style="margin:0;">Danh s√°ch s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng</h5>
            <button id="closeSapHet" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;">
            <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
                <span style="color: #000; font-weight: 500;">Ng∆∞·ª°ng c·∫£nh b√°o (‚â§ s·ªë l∆∞·ª£ng):</span>
                <input type="number" id="inpThreshold" class="form-control w-auto" value="10" min="1" title="Hi·ªÉn th·ªã s·∫£n ph·∫©m c√≥ s·ªë l∆∞·ª£ng nh·ªè h∆°n ho·∫∑c b·∫±ng gi√° tr·ªã n√†y">
                <span style="color: #000; font-weight: 500;">S·ªë l∆∞·ª£ng hi·ªÉn th·ªã:</span>
                <input type="number" id="inpLimit" class="form-control w-auto" value="10" min="1" title="S·ªë s·∫£n ph·∫©m t·ªëi ƒëa hi·ªÉn th·ªã trong danh s√°ch">
                <button id="btnReloadLow" class="btn btn-primary">T·∫£i l·∫°i</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>·∫¢nh</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√°</th>
                            <th>Thu·ªôc t√≠nh</th>
                        </tr>
                    </thead>
                    <tbody id="tbodySapHetHang"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.6/jquery.simplePagination.min.js"></script>
<!-- Load scripts -->
<script th:src="@{/admin/assets/compiled/js/chart.umd.min.js}"></script>

<!-- Sidebar Script -->
<div th:replace="/admin/fragments/scripts :: sidebar-script"></div>

<script>
window.addEventListener('load', function() {
    console.log('Page loaded, checking Chart.js...');
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        alert('L·ªói: Chart.js kh√¥ng ƒë∆∞·ª£c load. Vui l√≤ng refresh trang.');
        return;
    }
    console.log('Chart.js loaded successfully:', Chart.version);

    // Card t·ªïng quan
    async function loadCardTongQuan() {
        console.log('Loading card t·ªïng quan...');
        const res = await fetch('/api/thong-ke/doanh-thu-tong-hop');
        const data = res.ok ? await res.json() : {};
        console.log('Card t·ªïng quan data:', data);
        document.getElementById('cardTongDoanhThu').textContent = data.tongDoanhThu?.toLocaleString() + ' ƒë' || '0 ƒë';
        document.getElementById('cardDoanhThuHomNay').textContent = data.doanhThuHomNay?.toLocaleString() + ' ƒë' || '0 ƒë';
        document.getElementById('cardDoanhThuTuanNay').textContent = data.doanhThuTuanNay?.toLocaleString() + ' ƒë' || '0 ƒë';
        document.getElementById('cardDoanhThuThangNay').textContent = data.doanhThuThangNay?.toLocaleString() + ' ƒë' || '0 ƒë';
    }
    
    // Load tr·∫°ng th√°i ƒë∆°n h√†ng
    async function loadTrangThaiDonHang() {
        console.log('Loading tr·∫°ng th√°i ƒë∆°n h√†ng...');
        const res = await fetch('/api/thong-ke/trang-thai-don-hang');
        const data = res.ok ? await res.json() : {};
        console.log('Tr·∫°ng th√°i ƒë∆°n h√†ng data:', data);
        
        // T·∫°o bi·ªÉu ƒë·ªì tr√≤n
        const chartData = {
            labels: ['ƒêang giao h√†ng', 'ƒê√£ h·ªßy', 'Ho√†n th√†nh'],
            datasets: [{
                data: [data.dangGiaoHang || 0, data.daHuy || 0, data.hoanThanh || 0],
                backgroundColor: [
                    '#fff3cd', // V√†ng nh·∫°t cho ƒëang giao h√†ng
                    '#f8d7da', // ƒê·ªè nh·∫°t cho ƒë√£ h·ªßy
                    '#d1edff'  // Xanh nh·∫°t cho ho√†n th√†nh
                ],
                borderColor: [
                    '#856404', // V√†ng ƒë·∫≠m
                    '#721c24', // ƒê·ªè ƒë·∫≠m
                    '#0c5460'  // Xanh ƒë·∫≠m
                ],
                borderWidth: 2
            }]
        };
        
        if (chartTrangThaiDonHang) {
            chartTrangThaiDonHang.destroy();
        }
        
        chartTrangThaiDonHang = new Chart(document.getElementById('chartTrangThaiDonHang').getContext('2d'), {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} ƒë∆°n h√†ng (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Load th·ªëng k√™ kh√°c
    async function loadThongKeKhac() {
        console.log('Loading th·ªëng k√™ kh√°c...');
        const res = await fetch('/api/thong-ke/thong-ke-khac');
        const data = res.ok ? await res.json() : {};
        console.log('Th·ªëng k√™ kh√°c data:', data);
        
        document.getElementById('cardPhieuGiamGia').textContent = data.phieuGiamGia || '0';
        document.getElementById('cardSanPhamBanChay').textContent = data.sanPhamBanChay || '0';
        document.getElementById('cardSanPhamHetHang').textContent = data.sanPhamHetHang || '0';
        document.getElementById('cardTongDonHang').textContent = data.tongDonHang || '0';
    }
    // Helper: fill select th√°ng/nƒÉm
    function fillMonthYearSelects() {
        const now = new Date();
        const selectMonth = document.getElementById('selectMonth');
        const selectYear = document.getElementById('selectYear');
        const selectYearThang = document.getElementById('selectYearThang');
        selectMonth.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            selectMonth.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>Th√°ng ${m}</option>`;
        }
        selectYear.innerHTML = '';
        selectYearThang.innerHTML = '';
        for (let y = now.getFullYear() - 5; y <= now.getFullYear() + 1; y++) {
            selectYear.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
            selectYearThang.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
        }
    }
    // Chart.js instance
    let chartNgay, chartThang, chartKhoang, chartTrangThaiDonHang;
    // Load chart doanh thu t·ª´ng ng√†y trong th√°ng
    async function loadChartNgay() {
        console.log('Loading chart ng√†y...');
        const month = document.getElementById('selectMonth').value;
        const year = document.getElementById('selectYear').value;
        const res = await fetch(`/api/thong-ke/doanh-thu-ngay-trong-thang?year=${year}&month=${month}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart ng√†y data:', data);
        const labels = data.map(d => d.ngay);
        const values = data.map(d => d.tongDoanhThu);
        if (chartNgay) chartNgay.destroy();
        chartNgay = new Chart(document.getElementById('chartNgay').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(59,89,152,0.8)',
                    borderColor: '#3b5998',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ƒë';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart ng√†y created successfully');
    }
    // Load chart doanh thu t·ª´ng th√°ng trong nƒÉm
    async function loadChartThang() {
        console.log('Loading chart th√°ng...');
        const year = document.getElementById('selectYearThang').value;
        const res = await fetch(`/api/thong-ke/doanh-thu-thang-trong-nam?year=${year}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart th√°ng data:', data);
        const labels = data.map(d => 'Th√°ng ' + d.thang);
        const values = data.map(d => d.tongDoanhThu);
        if (chartThang) chartThang.destroy();
        chartThang = new Chart(document.getElementById('chartThang').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(26,188,156,0.8)',
                    borderColor: '#1abc9c',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ƒë';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart th√°ng created successfully');
    }
    // Load chart doanh thu theo kho·∫£ng ng√†y
    async function loadChartKhoang() {
        console.log('Loading chart kho·∫£ng...');
        const from = document.getElementById('fromDate').value;
        const to = document.getElementById('toDate').value;
        if (!from || !to) return;
        const res = await fetch(`/api/thong-ke/doanh-thu-theo-khoang?from=${from}&to=${to}`);
        const data = res.ok ? await res.json() : [];
        console.log('Chart kho·∫£ng data:', data);
        const labels = data.map(d => d.ngay);
        const values = data.map(d => d.tongDoanhThu);
        if (chartKhoang) chartKhoang.destroy();
        chartKhoang = new Chart(document.getElementById('chartKhoang').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    backgroundColor: 'rgba(243,156,18,0.8)',
                    borderColor: '#f39c12',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ƒë';
                            }
                        }
                    } 
                } 
            }
        });
        console.log('Chart kho·∫£ng created successfully');
    }
    // S·ª± ki·ªán
    console.log('Initializing charts...');
    fillMonthYearSelects();
    loadCardTongQuan();
    loadTrangThaiDonHang(); // Call the new function here
    loadThongKeKhac(); // Call the new function here
    loadChartNgay();
    loadChartThang();
    document.getElementById('selectMonth').onchange = loadChartNgay;
    document.getElementById('selectYear').onchange = loadChartNgay;
    document.getElementById('selectYearThang').onchange = loadChartThang;
    document.getElementById('btnKhoang').onclick = loadChartKhoang;
    console.log('Charts initialized successfully');

    // G·∫Øn s·ª± ki·ªán click card ƒë·ªÉ m·ªü modal custom
    const cardBanChay = document.getElementById('cardBanChayContainer');
    if (cardBanChay) {
        cardBanChay.addEventListener('click', function(){
            document.getElementById('modalTopBanChay').style.display = 'block';
            loadTopBanChay('day');
        });
    }
    const cardHetHang = document.getElementById('cardHetHangContainer');
    if (cardHetHang) {
        cardHetHang.addEventListener('click', function(){
            document.getElementById('modalSapHetHang').style.display = 'block';
            loadSapHetHang();
        });
    }
    
    // N√∫t ƒë√≥ng modal
    const closeBanChay = document.getElementById('closeBanChay');
    if (closeBanChay) {
        closeBanChay.addEventListener('click', function(){
            document.getElementById('modalTopBanChay').style.display = 'none';
        });
    }
    const closeSapHet = document.getElementById('closeSapHet');
    if (closeSapHet) {
        closeSapHet.addEventListener('click', function(){
            document.getElementById('modalSapHetHang').style.display = 'none';
        });
    }

    // N√∫t filter trong modal Top b√°n ch·∫°y
    const scopeBtns = document.querySelectorAll('#modalTopBanChay [data-scope]');
    if (scopeBtns && scopeBtns.length) {
        scopeBtns.forEach(btn => {
            btn.addEventListener('click', ()=>{
                const scope = btn.getAttribute('data-scope');
                const topFrom = document.getElementById('topFrom');
                const topTo = document.getElementById('topTo');
                const btnApply = document.getElementById('btnApplyCustomTop');
                if(scope==='custom'){
                    if (topFrom) topFrom.style.display='block';
                    if (topTo) topTo.style.display='block';
                    if (btnApply) btnApply.style.display='block';
                } else {
                    if (topFrom) topFrom.style.display='none';
                    if (topTo) topTo.style.display='none';
                    if (btnApply) btnApply.style.display='none';
                    loadTopBanChay(scope);
                }
            });
        });
    }
    const btnApplyCustomTop = document.getElementById('btnApplyCustomTop');
    if (btnApplyCustomTop) {
        btnApplyCustomTop.addEventListener('click', ()=>{
            const from = document.getElementById('topFrom')?.value;
            const to = document.getElementById('topTo')?.value;
            if(from && to){
                loadTopBanChay('custom', from, to);
            }
        });
    }

    async function loadTopBanChay(scope, from, to){
        const params = new URLSearchParams({scope});
        if(scope==='custom' && from && to){ params.append('from', from); params.append('to', to); }
        const res = await fetch(`/api/thong-ke/top-ban-chay?${params.toString()}`);
        const data = res.ok ? await res.json() : [];
        const tbody = document.getElementById('tbodyTopBanChay');
        if (!tbody) return;
        tbody.innerHTML = '';
        if(!data.length){
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No Data Found</td></tr>';
            return;
        }
        data.forEach((row, idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${row.tenSanPham}</td><td>${row.soLuongBan}</td><td>${(row.tongTien||0).toLocaleString('vi-VN')} ƒë</td>`;
            tbody.appendChild(tr);
        });
    }

    const btnReloadLow = document.getElementById('btnReloadLow');
    if (btnReloadLow) {
        btnReloadLow.addEventListener('click', loadSapHetHang);
    }
    async function loadSapHetHang(){
        const thresholdEl = document.getElementById('inpThreshold');
        const limitEl = document.getElementById('inpLimit');
        const threshold = thresholdEl ? (thresholdEl.value || 10) : 10;
        const limit = limitEl ? (limitEl.value || 10) : 10;
        const res = await fetch(`/api/thong-ke/sap-het-hang?threshold=${threshold}&limit=${limit}`);
        const data = res.ok ? await res.json() : [];
        const tbody = document.getElementById('tbodySapHetHang');
        if (!tbody) return;
        tbody.innerHTML = '';
        if(!data.length){
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No Data Found</td></tr>';
            return;
        }
        data.forEach((row, idx)=>{
            const img = row.hinhAnh ? `<img src="${row.hinhAnh}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;"/>` : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${img}</td><td>${row.tenSanPham||''}</td><td>${row.soLuong||0}</td><td>${(row.gia||0).toLocaleString('vi-VN')} ƒë</td><td>${row.thuocTinh||''}</td>`;
            tbody.appendChild(tr);
        });
    }
});
</script>
</body>
</html> 